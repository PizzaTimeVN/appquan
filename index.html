<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Pizza</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: #d32f2f;
            text-align: center;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #d32f2f;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #b71c1c;
        }

        .btn-secondary {
            background: #757575;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-info {
            flex: 1;
        }

        .header-info h3 {
            color: #d32f2f;
            margin-bottom: 5px;
        }

        .header-info p {
            color: #666;
            font-size: 14px;
        }

        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tab-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }

        .tab-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
        }

        .tab-card h3 {
            color: #d32f2f;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .tab-card p {
            color: #666;
            font-size: 14px;
        }

        .content-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            color: #d32f2f;
            font-size: 24px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .revenue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .revenue-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .revenue-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .category-list {
            display: grid;
            gap: 15px;
        }

        .category-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .category-header {
            background: #f5f5f5;
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header:hover {
            background: #eeeeee;
        }

        .category-content {
            display: none;
            padding: 15px;
        }

        .category-content.active {
            display: block;
        }

        .item-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .item-input:last-child {
            border-bottom: none;
        }

        .item-input label {
            flex: 1;
            font-weight: 500;
        }

        .item-input input {
            width: 100px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
        }

        .order-list {
            display: grid;
            gap: 15px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .order-item.low-stock {
            border-color: #d32f2f;
            background: #ffebee;
        }

        .order-item-name {
            flex: 1;
            font-weight: 500;
        }

        .order-item-stock {
            margin: 0 20px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 6px;
            font-weight: 600;
        }

        .order-item.low-stock .order-item-stock {
            background: #d32f2f;
            color: white;
        }

        .order-item input {
            width: 100px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
        }

        .check-pizza-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .check-pizza-grid {
                grid-template-columns: 1fr;
            }
        }

        .check-input-section, .check-result-section {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .check-input-section h4, .check-result-section h4 {
            margin-bottom: 20px;
            color: #d32f2f;
        }

        .pizza-size-group {
            margin-bottom: 20px;
        }

        .pizza-size-group h5 {
            margin-bottom: 15px;
            color: #555;
        }

        .pizza-input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pizza-input-row label {
            flex: 1;
        }

        .pizza-input-row input {
            width: 100px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
        }

        .result-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .result-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }

        .result-message.error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #d32f2f;
        }

        .shortage-list {
            margin-top: 15px;
        }

        .shortage-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .hidden {
            display: none;
        }

        .back-btn {
            background: #757575;
            display: inline-block;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #616161;
        }

        .save-btn {
            margin-top: 20px;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .category-item.active .arrow {
            transform: rotate(180deg);
        }
        /* Gộp 2 input trên 1 dòng */
.input-row {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.input-group-inline {
    display: flex;
    align-items: center;
    gap: 8px;
}

.input-group-inline input {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

/* Điều chỉnh hàng tồn */
.adjustment-box {
    margin-top: 25px;
    padding: 15px;
    border-radius: 10px;
    background: #f9f9f9;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

.adjustment-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.adjustment-row select, 
.adjustment-row input {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.adjustment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.adjustment-table th, 
.adjustment-table td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
}

.adjustment-table th {
    background: #f0f0f0;
}

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>🍕 Quản Lý Pizza</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Chọn Quán</label>
                    <select id="storeSelect" required>
                        <option value="">-- Chọn quán --</option>
                        <option value="DH">DH</option>
                        <option value="NH">NH</option>
                        <option value="HXH">HXH</option>
                        <option value="PY">PY</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tên Đăng Nhập</label>
                    <input type="text" id="username" required placeholder="Nhập tên đăng nhập">
                </div>
                <div class="form-group">
                    <label>Mật Khẩu</label>
                    <input type="password" id="password" required placeholder="Nhập mật khẩu">
                </div>
                <button type="submit" class="btn">Đăng Nhập</button>
            </form>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="hidden">
        <div class="header">
            <div class="header-info">
                <h3 id="storeName"></h3>
                <p id="userInfo"></p>
            </div>
            <button class="btn btn-secondary" onclick="logout()" style="width: auto; padding: 10px 30px;">Đăng Xuất</button>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="main-content">
            <div class="tabs">
                <div class="tab-card" onclick="showSection('revenue')">
                    <h3>💰 Nhập Doanh Thu</h3>
                    <p>Tiền mặt, chuyển khoản, Grab, Shopee</p>
                </div>
                <div class="tab-card" onclick="showSection('inventory')">
                    <h3>📦 Kiểm Hàng</h3>
                    <p>Kiểm tra tồn kho theo danh mục</p>
                </div>
                <div class="tab-card" onclick="showSection('order')">
                    <h3>🛒 Đặt Hàng</h3>
                    <p>Đặt hàng giao từ xưởng</p>
                </div>
                <div class="tab-card" onclick="showSection('checkPizza')">
                    <h3>✅ Check Bánh</h3>
                    <p>Kiểm tra số lượng bánh</p>
                </div>
            </div>
        </div>

        <!-- Revenue Section -->
        <div id="revenueSection" class="main-content content-section">
            <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
            <h2 class="section-title">Nhập Doanh Thu</h2>
            <div class="revenue-grid">
                <div class="revenue-item">
                    <label>💵 Tiền Mặt (VNĐ)</label>
                    <input type="text" id="cashRevenue" placeholder="0" min="0">
                </div>
                <div class="revenue-item">
                    <label>🏦 Chuyển Khoản (VNĐ)</label>
                    <input type="text" id="transferRevenue" placeholder="0" min="0">
                </div>
                <div class="revenue-item">
                    <label>🚗 Grab (VNĐ)</label>
                    <input type="text" id="grabRevenue" placeholder="0" min="0">
                </div>
                <div class="revenue-item">
                    <label>🛍️ Shopee (VNĐ)</label>
                    <input type="text" id="shopeeRevenue" placeholder="0" min="0">
                </div>
            </div>
            <button class="btn save-btn" onclick="saveRevenue()">Lưu Doanh Thu</button>
        </div>

        <!-- Inventory Section -->
   <div id="inventorySection" class="main-content content-section">
    <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>

    <!-- 🔹 Thông tin nhập kiểm hàng -->
    <div class="input-row">
        <div class="input-group-inline">
            <label for="inventoryDate">📅 Ngày nhập:</label>
            <input type="date" id="inventoryDate">
        </div>

        <div class="input-group-inline">
            <label for="inventoryUser">👤 Người nhập:</label>
            <input type="text" id="inventoryUser" placeholder="Nhập tên người kiểm hàng">
        </div>
    </div>

    <h2 class="section-title">Kiểm Hàng Tồn Kho</h2>
    <div id="inventoryList" class="category-list"></div>
    <button class="btn save-btn" onclick="saveInventory()">💾 Lưu Kiểm Hàng</button>

    <!-- 🔧 Điều chỉnh hàng tồn -->
    <div id="adjustmentSection" class="adjustment-box">
        <h3>🔧 Điều chỉnh hàng tồn</h3>

        <div class="adjustment-row">
            <select id="adjustProductSelect">
                <option value="">-- Chọn sản phẩm --</option>
            </select>

            <input type="number" id="adjustQtyInput" placeholder="Số lượng mới" min="0">

            <button class="btn small-btn" onclick="addAdjustment()">+ Thêm</button>
        </div>

        <table id="adjustmentTable" class="adjustment-table">
            <thead>
                <tr>
                    <th>Tên hàng</th>
                    <th>Số lượng mới</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="btn save-btn" onclick="saveAdjustments()">💾 Lưu thay đổi</button>
    </div>
        </div>

       

        <!-- Order Section -->
        <div id="orderSection" class="main-content content-section">
            <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
            <h2 class="section-title">Đặt Hàng Từ Xưởng</h2>
            <div id="orderList" class="order-list"></div>
            <button class="btn save-btn" onclick="saveOrder()">Gửi Đơn Đặt Hàng</button>
        </div>

        <!-- Check Pizza Section -->
        <div id="checkPizzaSection" class="main-content content-section">
            <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
            <h2 class="section-title">Check Bánh</h2>
            <div class="check-pizza-grid">
                <div class="check-input-section">
                    <h4>Nhập Số Lượng Bánh</h4>
                    <div class="pizza-size-group">
                        <h5>Size L</h5>
                        <div class="pizza-input-row">
                            <label>Trong máy tính tiền:</label>
                            <input type="number" id="pizzaL_system" min="0" value="0">
                        </div>
                        <div class="pizza-input-row">
                            <label>Số lượng mang ra:</label>
                            <input type="number" id="pizzaL_out" min="0" value="0">
                        </div>
                        <div class="pizza-input-row">
                            <label>Số lượng bánh bỏ:</label>
                            <input type="number" id="pizzaL_discard" min="0" value="0">
                        </div>
                    </div>
                    <div class="pizza-size-group">
                        <h5>Size S</h5>
                        <div class="pizza-input-row">
                            <label>Trong máy tính tiền:</label>
                            <input type="number" id="pizzaS_system" min="0" value="0">
                        </div>
                        <div class="pizza-input-row">
                            <label>Số lượng mang ra:</label>
                            <input type="number" id="pizzaS_out" min="0" value="0">
                        </div>
                        <div class="pizza-input-row">
                            <label>Số lượng bánh bỏ:</label>
                            <input type="number" id="pizzaS_discard" min="0" value="0">
                        </div>
                    </div>
                    <button class="btn" onclick="checkPizza()">Kiểm Tra</button>
                </div>
                <div class="check-result-section">
                    <h4>Kết Quả Kiểm Tra</h4>
                    <div id="checkResult"></div>
                </div>
            </div>
            <button class="btn save-btn" onclick="savePizzaCheck()">Lưu Check Bánh</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tyuufjwutazjfuiawiul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5dXVmand1dGF6amZ1aWF3aXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDk4OTIsImV4cCI6MjA3NjA4NTg5Mn0.8WEsb2tBD6akNA9h9tR9zIAqjkZz0xZYVNbYCx2dEbc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Discord Webhook
        const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1387472354149400748/t4uIPrQMAPg1MuUDOm8DW3r-2dDXQMQhdVxJ8QrUPX9igBBwyOOrsxVIdRQDzclI5smh';

        // Login credentials (cố định trong code)
        const CREDENTIALS = {
            'DH': { username: 'DH258', password: '258DH' },
            'NH': { username: 'NH141', password: '141NH' },
            'HXH': { username: 'HXH01', password: '01HXH' },
            'PY': { username: 'BT227', password: '227BT' }
        };

        const STORE_NAMES = {
            'DH': 'DH',
            'NH': 'NH',
            'HXH': 'HXH',
            'PY': 'PY'
        };

        // Inventory categories and items
        const INVENTORY_CATEGORIES = {
             'Làm bánh': [
                        'Đế L',
                        'Đế S',
                        'Phô Mai L',
                        'Phô Mai S',
                        'Bò pizza (bịch)',
                        'Bò mì Ý (bịch)',
                        'Gà pizza (bịch)',
                        'Tôm (bịch)',
                        'Mực (bịch)',
                        'Cá Ngừ (bịch)',
                        'XXH (bịch)',
                        'XXĐ (bịch)',
                        'Ba Rọi (bịch)',
                        'Bò sốt cay (bịch)',
                        'Sốt sữa (bịch)',
                        'Sốt cà (hũ)',
                        'Sốt Gà',
                        'Salami (bịch)',
                        'Nấm (bịch)',
                        'Bông Cải Xanh (bịch)',
                        
                    ],

            'Món ăn nhẹ': [
                'Gà Lắc (bịch)',
                'Đùi Gà (cái)',
                        'XX Chiên Xù',
                        'Bom Phô Mai (viên)',
                        'KTC (bịch)',
                        'Tok (bịch)'

            ],    

             'Bao bì ': [
                        'Bao 1 món (kg)',
                        'Bao pizza lớn (kg)',
                        'Bao cân mì (kg)',
                        'Bao rác (kg)',
                        'Dây thun (bịch)',
                        'Ly nhựa (lốc)',
                        'Hũ cá ngừ',
                        'Ống hút',
                        'Bì đựng ly',
                        'Hộp lớn',
                        'Hộp nhỏ'
                        
                    ],

            "Nước": [
                        'Coca chai',
                        'Coca lon',
                        'Nước suối',
                        'Bia Blance',
                        'Bia Quy Nhơn',
                        'Đá Me (bịch)',
                        'Mứt đào (bịch)',
                        'Miếng đào (bịch)',
                        'Trà chanh (hộp)',
                        'Trà đào (hộp)',
                    ],
    
        };

        let currentUser = null;
        let currentStore = null;
        let inventoryData = {};
        let pizzaCheckData = null;

        // Initialize inventory data
        function initInventoryData() {
            inventoryData = {};
            for (let category in INVENTORY_CATEGORIES) {
                INVENTORY_CATEGORIES[category].forEach(item => {
                    inventoryData[item] = 0;
                });
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const store = document.getElementById('storeSelect').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (CREDENTIALS[store] && 
                CREDENTIALS[store].username === username && 
                CREDENTIALS[store].password === password) {
                currentStore = store;
                currentUser = username;
                showApp();
            } else {
                alert('Sai tên đăng nhập hoặc mật khẩu!');
            }
        });

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            
            const today = new Date().toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('storeName').textContent = STORE_NAMES[currentStore];
            document.getElementById('userInfo').textContent = `${today} | Nhân viên: ${currentUser}`;
            
            initInventoryData();
            renderInventory();
            loadAdjustmentProducts();
            showMainMenu();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('inventoryDate');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        });

        function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                currentUser = null;
                currentStore = null;
            }
        }


        function showMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showSection(section) {
            document.getElementById('mainMenu').style.display = 'none';
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(section + 'Section').classList.add('active');
            
            if (section === 'order') {
                renderOrderList();
            }
        }

        function renderInventory() {
            const container = document.getElementById('inventoryList');
            container.innerHTML = '';
            
            for (let category in INVENTORY_CATEGORIES) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `${category} <span class="arrow">▼</span>`;
                header.onclick = function() {
                    categoryDiv.classList.toggle('active');
                    content.classList.toggle('active');
                };
                
                const content = document.createElement('div');
                content.className = 'category-content';
                
                INVENTORY_CATEGORIES[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-input';
                    itemDiv.innerHTML = `
                        <label>${item}</label>
                        <input type="number" min="0" value="${inventoryData[item]}" 
                               onchange="inventoryData['${item}'] = parseInt(this.value) || 0">
                    `;
                    content.appendChild(itemDiv);
                });
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                container.appendChild(categoryDiv);
            }
        }

                function loadAdjustmentProducts() {
            const select = document.getElementById("adjustProductSelect");
            if (!select) return;

            select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';

            // 🔹 Nếu có biến categories thì dùng, không thì lấy từ inventoryData
            if (typeof categories !== 'undefined') {
                for (const [groupName, items] of Object.entries(categories)) {
                    items.forEach(item => {
                        const option = document.createElement("option");
                        option.value = item;
                        option.textContent = `${groupName} - ${item}`;
                        select.appendChild(option);
                    });
                }
            } else if (typeof inventoryData !== 'undefined') {
                for (const item of Object.keys(inventoryData)) {
                    const option = document.createElement("option");
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                }
            }
        }

        function addAdjustment() {
                const productSelect = document.getElementById('adjustProductSelect');
                const qtyInput = document.getElementById('adjustQtyInput');
                const tableBody = document.querySelector('#adjustmentTable tbody');

                const product = productSelect.value;
                const qty = parseFloat(qtyInput.value);

                if (!product) {
                    alert("⚠️ Vui lòng chọn sản phẩm!");
                    return;
                }
                if (isNaN(qty)) {
                    alert("⚠️ Vui lòng nhập số lượng mới!");
                    return;
                }

                // 🔹 Thêm vào danh sách điều chỉnh
                adjustments.push({ product, qty });

                // 🔹 Hiển thị lên bảng
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product}</td>
                    <td>${qty}</td>
                    <td><button class="btn small-btn" onclick="removeAdjustment(this)">🗑️</button></td>
                `;
                tableBody.appendChild(row);

                // Reset input
                productSelect.value = "";
                qtyInput.value = "";
            }
                window.addAdjustment = addAdjustment;
                window.removeAdjustment = removeAdjustment;
                window.saveAdjustments = saveAdjustments;


            function removeAdjustment(button) {
                const row = button.closest('tr');
                const productName = row.children[0].textContent;
                adjustments = adjustments.filter(a => a.product !== productName);
                row.remove();
            }

           async function saveAdjustments() {
    if (adjustments.length === 0) {
        alert("⚠️ Chưa có sản phẩm nào để lưu!");
        return;
    }

    const dateInput = document.getElementById('inventoryDate').value;
    if (!dateInput) {
        alert("⚠️ Vui lòng chọn ngày kiểm hàng!");
        return;
    }

    try {
        // 🔹 Lấy dữ liệu tồn kho cũ
        const { data: existing, error: existingError } = await supabase
            .from('ton_quan')
            .select('id, inventory')
            .eq('store_id', currentStore)
            .eq('date', dateInput)
            .single();

        if (existingError && existingError.code !== 'PGRST116') throw existingError;

        const oldInventory = existing?.inventory || {};

        // 🔹 Cập nhật số lượng cho các sản phẩm được điều chỉnh
        const newInventory = { ...oldInventory };
        adjustments.forEach(adj => {
            newInventory[adj.product] = adj.qty;
        });

        // 🔹 Xóa bản ghi cũ (nếu có)
        if (existing) {
            const { error: delError } = await supabase
                .from('ton_quan')
                .delete()
                .eq('id', existing.id);
            if (delError) throw delError;
        }

        // 🔹 Thêm bản ghi mới (tồn kho sau điều chỉnh)
        const { error: insertError } = await supabase
            .from('ton_quan')
            .insert([
                {
                    store_id: currentStore,
                    date: dateInput,
                    inventory: newInventory
                }
            ]);

        if (insertError) throw insertError;

        // 🔹 Cập nhật local và giao diện
        inventoryData = newInventory;
        adjustments = [];
        document.querySelector('#adjustmentTable tbody').innerHTML = "";

        alert("✅ Đã lưu tồn kho sau điều chỉnh!");
        // ✅ Gọi cập nhật lại giao diện đặt hàng
await new Promise(r => setTimeout(r, 1000)); // đợi 0.3s cho Supabase cập nhật xong
await renderOrderList();

    } catch (err) {
        console.error("❌ Lỗi khi lưu điều chỉnh:", err);
        alert("❌ Có lỗi khi lưu điều chỉnh!");
    }
}

        async function renderOrderList() {
    const container = document.getElementById('orderList');
    container.innerHTML = '<div class="loading">⏳ Đang tải dữ liệu tồn kho...</div>';

    try {
        // 🔹 Lấy bản ghi mới nhất theo created_at
        const { data, error } = await supabase
            .from('ton_quan')
            .select('inventory, date, created_at')
            .eq('store_id', currentStore)
            .order('created_at', { ascending: false })
            .limit(1);

        if (error) throw error;
        if (!data || data.length === 0) {
            container.innerHTML = '<p>⚠️ Chưa có dữ liệu tồn kho cho quán này.</p>';
            return;
        }

        const latest = data[0];
        inventoryData = latest.inventory || {};

        container.innerHTML = '';

        for (const [item, stock] of Object.entries(inventoryData)) {
            const isLowStock = stock < 3;
            const div = document.createElement('div');
            div.className = `order-item${isLowStock ? ' low-stock' : ''}`;
            div.innerHTML = `
                <span class="order-item-name">${item}</span>
                <span class="order-item-stock">Tồn: ${stock}</span>
                <input type="number" min="0" value="0" placeholder="Số lượng đặt">
            `;
            container.appendChild(div);
        }

        const info = document.createElement('div');
        info.className = 'info-text';
        info.style.marginTop = '8px';
        info.style.fontSize = '13px';
        info.style.color = '#777';
        info.textContent = `📅 Dữ liệu tồn kho mới nhất: ${new Date(latest.date).toLocaleDateString('vi-VN')} (cập nhật ${new Date(latest.created_at).toLocaleString('vi-VN')})`;
        container.appendChild(info);

    } catch (err) {
        console.error('❌ Lỗi renderOrderList:', err);
        container.innerHTML = '<p>❌ Không thể tải dữ liệu tồn kho. Vui lòng thử lại!</p>';
    }
}
            

        function checkPizza() {
            const pizzaL_system = parseInt(document.getElementById('pizzaL_system').value) || 0;
            const pizzaL_out = parseInt(document.getElementById('pizzaL_out').value) || 0;
            const pizzaL_discard = parseInt(document.getElementById('pizzaL_discard').value) || 0;
            
            const pizzaS_system = parseInt(document.getElementById('pizzaS_system').value) || 0;
            const pizzaS_out = parseInt(document.getElementById('pizzaS_out').value) || 0;
            const pizzaS_discard = parseInt(document.getElementById('pizzaS_discard').value) || 0;

            const pizzaL_expected = pizzaL_out - pizzaL_discard;
            const pizzaS_expected = pizzaS_out - pizzaS_discard;

            const pizzaL_diff = pizzaL_system - pizzaL_expected;
            const pizzaS_diff = pizzaS_system - pizzaS_expected;

            const resultDiv = document.getElementById('checkResult');
            
            pizzaCheckData = {
                sizeL: { system: pizzaL_system, out: pizzaL_out, discard: pizzaL_discard, diff: pizzaL_diff },
                sizeS: { system: pizzaS_system, out: pizzaS_out, discard: pizzaS_discard, diff: pizzaS_diff }
            };

            if (pizzaL_diff === 0 && pizzaS_diff === 0) {
                resultDiv.innerHTML = '<div class="result-message success">✓ Đủ bánh! Số lượng bánh khớp chính xác.</div>';
            } else {
                let html = '<div class="result-message error">✗ Không khớp số lượng bánh</div>';
                html += '<div class="shortage-list">';
                if (pizzaL_diff !== 0) {
                    html += `<div class="shortage-item">Size L: ${pizzaL_diff > 0 ? 'Thừa ' + pizzaL_diff : 'Thiếu ' + Math.abs(pizzaL_diff)} bánh</div>`;
                }
                if (pizzaS_diff !== 0) {
                    html += `<div class="shortage-item">Size S: ${pizzaS_diff > 0 ? 'Thừa ' + pizzaS_diff : 'Thiếu ' + Math.abs(pizzaS_diff)} bánh</div>`;
                }
                html += '</div>';
                resultDiv.innerHTML = html;
            }
        }

        function formatNumberInput(input) {
            input.addEventListener('input', () => {
                let value = input.value.replace(/[^0-9]/g, ''); // bỏ ký tự không phải số
                if (value) {
                    input.value = parseInt(value).toLocaleString('vi-VN'); // format theo chuẩn VN
                } else {
                    input.value = '';
                }
            });
        }

        // Gán cho tất cả các input doanh thu
        ['cashRevenue', 'transferRevenue', 'grabRevenue', 'shopeeRevenue'].forEach(id => {
            const el = document.getElementById(id);
            if (el) formatNumberInput(el);
        });

        // Save functions
        async function saveRevenue() {
            const cash = parseFloat(document.getElementById('cashRevenue').value) || 0;
            const transfer = parseFloat(document.getElementById('transferRevenue').value) || 0;
            const grab = parseFloat(document.getElementById('grabRevenue').value) || 0;
            const shopee = parseFloat(document.getElementById('shopeeRevenue').value) || 0;

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: new Date().toISOString(),
                cash_revenue: cash,
                transfer_revenue: transfer,
                grab_revenue: grab,
                shopee_revenue: shopee,
                total_revenue: cash + transfer + grab + shopee
            };

            try {
                const { error } = await supabase.from('sale_quan').insert([data]);
                if (error) throw error;
                alert('Đã lưu doanh thu thành công!');
                document.querySelectorAll('#revenueSection input').forEach(input => input.value = '');
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi khi lưu dữ liệu. Vui lòng thử lại!');
            }
        }

          // --- 🧾 Lưu điều chỉnh tồn kho ---
async function saveAdjustments() {
    if (adjustments.length === 0) {
        alert("⚠️ Chưa có sản phẩm nào để lưu!");
        return;
    }

    const dateInput = document.getElementById('inventoryDate').value;
    const userInput = document.getElementById('inventoryUser').value.trim();

    if (!dateInput || !userInput) {
        alert("⚠️ Vui lòng nhập đủ ngày và người kiểm hàng!");
        return;
    }

    try {
        // 🔹 Lấy bản tồn kho mới nhất của quán
        const { data: latest, error: latestError } = await supabase
            .from('ton_quan')
            .select('inventory')
            .eq('store_id', currentStore)
            .order('created_at', { ascending: false })
            .limit(1);

        if (latestError) throw latestError;

        let inventory = latest && latest.length > 0
            ? { ...latest[0].inventory }
            : {};

        // 🔹 Cập nhật các mặt hàng được điều chỉnh
        adjustments.forEach(adj => {
            inventory[adj.product] = adj.qty;
        });

        // 🔹 Tạo dữ liệu mới (lưu thành bản ghi mới chứ không ghi đè)
        const newRecord = {
            store_id: currentStore,
            date: dateInput,
            username: currentUser,
            input_user: userInput,
            inventory: inventory
        };

        const { error: insertError } = await supabase
            .from('ton_quan')
            .insert([newRecord]);

        if (insertError) throw insertError;

        alert("✅ Đã lưu điều chỉnh tồn kho mới nhất!");

        // 🔹 Cập nhật lại biến inventoryData cục bộ
        inventoryData = inventory;

        // 🔹 Làm sạch danh sách điều chỉnh
        adjustments = [];
        document.querySelector('#adjustmentTable tbody').innerHTML = "";

        // 🔹 Render lại danh sách đặt hàng (tab xưởng)
        if (typeof renderOrderList === 'function') {
            renderOrderList();
        }

    } catch (err) {
        console.error("❌ Lỗi khi lưu điều chỉnh:", err);
        alert("❌ Lỗi khi lưu điều chỉnh, vui lòng thử lại!");
    }
}




                async function saveOrder() {
                const orderItems = [];
                const inputs = document.querySelectorAll('#orderList input');
                const items = Object.keys(inventoryData);

                // 🧮 Tạo danh sách món đặt
                inputs.forEach((input, index) => {
                    const quantity = parseInt(input.value) || 0;
                    if (quantity > 0) {
                        orderItems.push({
                            item: items[index],
                            current_stock: inventoryData[items[index]],
                            order_quantity: quantity
                        });
                    }
                });

                if (orderItems.length === 0) {
                    alert('Vui lòng nhập số lượng hàng cần đặt!');
                    return;
                }

                // 🗂 Chuẩn bị dữ liệu để lưu Supabase
                const data = {
                    store_id: currentStore,
                    username: currentUser,
                    date: new Date().toISOString(),
                    order_items: orderItems
                };

                try {
                    // 1️⃣ Lưu vào Supabase
                    const { error } = await supabase.from('order_quan').insert([data]);
                    if (error) throw error;

                    // 2️⃣ Gửi thông báo Telegram
                    await sendTelegramNotification(data, orderItems);

                    // 3️⃣ Reset form
                    alert('✅ Đã lưu đơn hàng và gửi thông báo thành công!');
                    document.querySelectorAll('#orderList input').forEach(input => input.value = '0');

                } catch (error) {
                    console.error('Error:', error);
                    alert('❌ Có lỗi khi lưu dữ liệu hoặc gửi thông báo. Vui lòng thử lại!');
                }
            }


            // --- 📨 Gửi thông báo Telegram ---
            async function sendTelegramNotification(data, orderItems) {
                const botToken = '8036982528:AAEymf0l1HH47SB10gcd7QwxyugpBLxrvas'; // Token bot
                const chatId = '-4776196182'; // ID nhóm hoặc user

                const dateStr = new Date().toLocaleString('vi-VN', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                // 🔹 Tách riêng tên hàng & số lượng
                const itemNames = orderItems.map(i => `• ${i.item}`).join('\n');
                const itemQtys = orderItems.map(i => `• ${i.order_quantity}`).join('\n');

                // 🔹 Gộp tên hàng và số lượng trên cùng 1 dòng
                    const itemsList = orderItems
                    .map(i => `${i.item.padEnd(20, ' ')} - ${i.order_quantity}`)
                    .join('\n');

                    const message =
                    `🛒 *ĐƠN ĐẶT HÀNG MỚI*

                    🏪 *Quán:* ${STORE_NAMES[data.store_id] || 'Không xác định'}
                    👤 *Người đặt:* ${data.username}
                    📅 *Thời gian:* ${dateStr}

                    📦 *Danh sách hàng đặt:*
                    \`\`\`
                    ${itemsList}
                    \`\`\`

_Hệ thống quản lý Pizza_`;

                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

                const payload = {
                    chat_id: chatId,
                    text: message,
                    parse_mode: "Markdown"
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!result.ok) throw new Error(result.description);
            }


            function updateOrderList() {
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = ''; // Xóa cũ, tạo mới

                for (const [item, qty] of Object.entries(inventoryData)) {
                    const row = document.createElement('div');
                    row.classList.add('order-item');
                    row.innerHTML = `
                        <span>${item}</span>
                        <span>📦 Tồn: ${qty}</span>
                        <input type="number" min="0" value="0">
                    `;
                    orderList.appendChild(row);
                }
            }

        async function savePizzaCheck() {
            if (!pizzaCheckData) {
                alert('Vui lòng kiểm tra bánh trước khi lưu!');
                return;
            }

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: new Date().toISOString(),
                pizza_check: pizzaCheckData
            };

            try {
                const { error } = await supabase.from('pizza_check').insert([data]);
                if (error) throw error;
                alert('Đã lưu check bánh thành công!');
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi khi lưu dữ liệu. Vui lòng thử lại!');
            }
        }
                let adjustments = [];
        

    </script>
</body>
</html>
