<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Pizza</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff; /* M√†u tr·∫Øng */
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h3 {
            color: #333;
            font-size: 24px;
        }

        .header p {
            color: #666;
            margin-top: 5px;
        }

        .btn-logout {
            padding: 10px 25px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tab-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tab-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .tab-card p {
            color: #777;
            font-size: 14px;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .back-btn {
            background: #6c757d;
            width: auto;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .category-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .category-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header:hover {
            background: #e9ecef;
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-item.active .category-content {
            max-height: 2000px;
            padding: 20px;
        }

        .item-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .item-input:last-child {
            border-bottom: none;
        }

        .item-input label {
            flex: 1;
            color: #555;
        }

        .item-input input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .save-btn {
            margin-top: 30px;
            background: #28a745;
        }

        .save-btn:hover {
            background: #218838;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group-inline {
            display: flex;
            flex-direction: column;
        }

        .input-group-inline label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group-inline input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .adjustment-box {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .adjustment-box h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .adjustment-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
        }

        .adjustment-row select,
        .adjustment-row input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .small-btn {
            padding: 10px 20px;
            width: auto;
        }

        .adjustment-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .adjustment-table th,
        .adjustment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .adjustment-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .order-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .order-item.low-stock {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .order-item input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .revenue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .revenue-item label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        .revenue-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .item-list {
            margin: 20px 0;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .item-row select,
        .item-row input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .btn-add {
            background: #17a2b8;
            width: auto;
            padding: 12px 30px;
            margin-right: 10px;
        }

        .btn-remove {
            background: #dc3545;
            width: auto;
            padding: 10px 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .info-text {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            color: #004085;
        }

        @media (max-width: 768px) {
            .tabs {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .item-row {
                grid-template-columns: 1fr;
            }

            .adjustment-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-box">
                <h2>üçï Qu·∫£n L√Ω Pizza</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Ch·ªçn Qu√°n</label>
                        <select id="storeSelect" required>
                            <option value="">-- Ch·ªçn qu√°n --</option>
                            <option value="DH">DH</option>
                            <option value="NH">NH</option>
                            <option value="HXH">HXH</option>
                            <option value="PY">PY</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√™n ƒêƒÉng Nh·∫≠p</label>
                        <input type="text" id="username" required placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                    </div>
                    <div class="form-group">
                        <label>M·∫≠t Kh·∫©u</label>
                        <input type="password" id="password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                    </div>
                    <button type="submit" class="btn">ƒêƒÉng Nh·∫≠p</button>
                </form>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="appScreen" class="hidden">
            <div class="header">
                <div class="header-info">
                    <h3 id="storeName"></h3>
                    <p id="userInfo"></p>
                </div>
                <button class="btn-logout" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu">
                <div class="tabs">
                    <div class="tab-card" onclick="showSection('revenue')">
                        <h3>üí∞ Nh·∫≠p Doanh Thu</h3>
                        <p>Ti·ªÅn m·∫∑t, chuy·ªÉn kho·∫£n, Grab, Shopee</p>
                    </div>
                    <div class="tab-card" onclick="showSection('inventory')">
                        <h3>üì¶ Ki·ªÉm H√†ng</h3>
                        <p>Ki·ªÉm tra t·ªìn kho theo danh m·ª•c</p>
                    </div>
                    <div class="tab-card" onclick="showSection('order')">
                        <h3>üõí ƒê·∫∑t H√†ng</h3>
                        <p>ƒê·∫∑t h√†ng giao t·ª´ x∆∞·ªüng</p>
                    </div>
                    <div class="tab-card" onclick="showSection('sales')">
                        <h3>üìä Nh·∫≠p H√†ng B√°n</h3>
                        <p>Theo d√µi doanh s·ªë b√°n h√†ng</p>
                    </div>
                    <div class="tab-card" onclick="showSection('checkCake')">
                        <h3>üßÅ Check B√°nh</h3>
                        <p>Ki·ªÉm tra s·ªë l∆∞·ª£ng b√°nh b√°n th·ª±c t·∫ø</p>
                    </div>
                </div>
            </div>

            <!-- Revenue Section -->
            <div id="revenueSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">‚Üê Quay L·∫°i</button>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="revenueDate">üìÖ Ng√†y nh·∫≠p:</label>
                        <input type="date" id="revenueDate">
                    </div>
                </div>
                <h2 class="section-title">Nh·∫≠p Doanh Thu</h2>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>üíµ Ti·ªÅn M·∫∑t (VNƒê)</label>
                        <input type="text" id="cashRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>üè¶ Chuy·ªÉn Kho·∫£n (VNƒê)</label>
                        <input type="text" id="transferRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>üöó Grab (VNƒê)</label>
                        <input type="text" id="grabRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>üõçÔ∏è Shopee (VNƒê)</label>
                        <input type="text" id="shopeeRevenue" placeholder="0">
                    </div>
                </div>
                <button class="btn save-btn" onclick="saveRevenue()">L∆∞u Doanh Thu</button>
            </div>

            <!-- Inventory Section -->
            <div id="inventorySection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">‚Üê Quay L·∫°i</button>
                
                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="inventoryDate">üìÖ Ng√†y nh·∫≠p:</label>
                        <input type="date" id="inventoryDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="inventoryUser">üë§ Ng∆∞·ªùi nh·∫≠p:</label>
                        <input type="text" id="inventoryUser" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ki·ªÉm h√†ng">
                    </div>
                </div>

                <h2 class="section-title">Ki·ªÉm H√†ng T·ªìn Kho</h2>
                <div id="inventoryList" class="category-list"></div>
                <button class="btn save-btn" onclick="saveInventory()">üíæ L∆∞u Ki·ªÉm H√†ng</button>

                <div class="adjustment-box">
                    <h3>üîß ƒêi·ªÅu ch·ªânh h√†ng t·ªìn</h3>
                    <div class="adjustment-row">
                        <select id="adjustProductSelect">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        </select>
                        <input type="number" id="adjustQtyInput" placeholder="S·ªë l∆∞·ª£ng m·ªõi" min="0">
                        <button class="btn small-btn" onclick="addAdjustment()">+ Th√™m</button>
                    </div>
                    <table class="adjustment-table">
                        <thead>
                            <tr>
                                <th>T√™n h√†ng</th>
                                <th>S·ªë l∆∞·ª£ng m·ªõi</th>
                                <th>X√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="adjustmentTableBody"></tbody>
                    </table>
                    <button class="btn save-btn" onclick="saveAdjustments()">üíæ L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>

            <!-- Order Section -->
            <div id="orderSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">‚Üê Quay L·∫°i</button>
                <h2 class="section-title">ƒê·∫∑t H√†ng T·ª´ X∆∞·ªüng</h2>
                <div id="orderList"></div>
                <button class="btn save-btn" onclick="saveOrder()">G·ª≠i ƒê∆°n ƒê·∫∑t H√†ng</button>
            </div>

            <!-- Sales Section -->
            <div id="salesSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">‚Üê Quay L·∫°i</button>
                <h2 class="section-title">Nh·∫≠p H√†ng B√°n</h2>
                
                <div id="salesAlertContainer"></div>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="saleDate">üìÖ Ng√†y b√°n:</label>
                        <input type="date" id="saleDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="saleEmployee">üë§ Ng∆∞·ªùi nh·∫≠p:</label>
                        <input type="text" id="saleEmployee" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠p">
                    </div>
                </div>

                <div class="form-group">
                    <label for="salesCategory">Danh m·ª•c</label>
                    <select id="salesCategory" onchange="updateSalesProductList()">
                        <option value="">-- Ch·ªçn danh m·ª•c --</option>
                    </select>
                </div>

                <div class="item-list" id="salesItemList"></div>

                <button class="btn btn-add" onclick="addSalesItemRow()">+ Th√™m m·∫∑t h√†ng</button>
                <button class="btn save-btn" onclick="saveSalesData()">L∆∞u d·ªØ li·ªáu b√°n h√†ng</button>
            </div>

       <!-- Check Cake Section -->
            <div id="checkCakeSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">‚Üê Quay L·∫°i</button>
                <h2 class="section-title">üßÅ Check B√°nh</h2>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="cakeDate">üìÖ Ng√†y ki·ªÉm:</label>
                        <input type="date" id="cakeDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="cakeUser">üë§ Ng∆∞·ªùi ki·ªÉm:</label>
                        <input type="text" id="cakeUser" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ki·ªÉm b√°nh">
                    </div>
                </div>

                <h3 style="margin-top: 20px; margin-bottom: 15px;">S·ªë l∆∞·ª£ng ƒë·∫ø h√¥m qua & h√¥m nay (t·ª± ƒë·ªông)</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>ƒê·∫ø L h√¥m qua</label>
                        <input type="number" id="baseLYesterday" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø S h√¥m qua</label>
                        <input type="number" id="baseSYesterday" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø L h√¥m nay</label>
                        <input type="number" id="baseLToday" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø S h√¥m nay</label>
                        <input type="number" id="baseSToday" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">S·ªë l∆∞·ª£ng mang ra (t·ª± ƒë·ªông)</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>ƒê·∫ø L mang ra</label>
                        <input type="number" id="baseLOut" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø S mang ra</label>
                        <input type="number" id="baseSOut" placeholder="T·ª± ƒë·ªông l·∫•y" min="0" readonly>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Nh·∫≠p s·ªë l∆∞·ª£ng ƒë·∫ø b·ªè & m√°y b√°n</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>ƒê·∫ø L b·ªè</label>
                        <input type="number" id="baseLDiscard" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø S b·ªè</label>
                        <input type="number" id="baseSDiscard" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø L m√°y b√°n</label>
                        <input type="number" id="baseLMachine" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>ƒê·∫ø S m√°y b√°n</label>
                        <input type="number" id="baseSMachine" placeholder="0" min="0" value="0">
                    </div>
                </div>

                <button class="btn save-btn" onclick="checkCake()">üîç Ki·ªÉm Tra K·∫øt Qu·∫£</button>

                <div id="cakeResult" class="result-box" style="margin-top: 20px; display: none;"></div>

                <!-- N√∫t g·ª≠i Discord - hi·ªán sau khi ki·ªÉm tra -->
                <button class="btn save-btn" onclick="sendCakeResultToDiscord()" id="sendDiscordBtn" style="display:none; margin-top: 15px; background-color: #5865F2;">
                    üì§ G·ª≠i K·∫øt Qu·∫£ 
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tyuufjwutazjfuiawiul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5dXVmand1dGF6amZ1aWF3aXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDk4OTIsImV4cCI6MjA3NjA4NTg5Mn0.8WEsb2tBD6akNA9h9tR9zIAqjkZz0xZYVNbYCx2dEbc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Login credentials
        const CREDENTIALS = {
            'DH': { username: 'DH258', password: '258DH' },
            'NH': { username: 'NH141', password: '141NH' },
            'HXH': { username: 'HXH01', password: '01HXH' },
            'PY': { username: 'BT227', password: '227BT' }
        };

        const STORE_NAMES = {
            'DH': 'DH',
            'NH': 'NH',
            'HXH': 'HXH',
            'PY': 'PY'
        };

        // Inventory categories
        const INVENTORY_CATEGORIES = {
           'L√†m b√°nh': [
                        'ƒê·∫ø L',
                        'ƒê·∫ø S',
                        'Ph√¥ Mai L',
                        'Ph√¥ Mai S',
                        'B√≤ pizza (b·ªãch)',
                        'B√≤ m√¨ √ù (b·ªãch)',
                        'G√† pizza (b·ªãch)',
                        'T√¥m (b·ªãch)',
                        'M·ª±c (b·ªãch)',
                        'C√° Ng·ª´ (b·ªãch)',
                        'XXH (b·ªãch)',
                        'XXƒê (b·ªãch)',
                        'Ba R·ªçi (b·ªãch)',
                        'B√≤ s·ªët cay (b·ªãch)',
                        'S·ªët s·ªØa (b·ªãch)',
                        'S·ªët c√† (h≈©)',
                        'S·ªët G√†',
                        'Salami (b·ªãch)',
                        'N·∫•m (b·ªãch)',
                        'B√¥ng C·∫£i Xanh (b·ªãch)',
                        
                    ],

            'M√≥n ƒÉn nh·∫π': [
                'G√† L·∫Øc (b·ªãch)',
                'ƒê√πi G√† (c√°i)',
                        'XX Chi√™n X√π',
                        'Bom Ph√¥ Mai (vi√™n)',
                        'KTC (b·ªãch)',
                        'M√¨ √Ω ch∆∞a lu·ªôc',
                        'B√°nh m√¨',
                        'Tok (b·ªãch)'

            ],    

             'Bao b√¨ ': [
                        'Bao 1 m√≥n (kg)',
                        'Bao pizza l·ªõn (kg)',
                        'Bao c√¢n m√¨ (kg)',
                        'Bao r√°c (kg)',
                        'D√¢y thun (b·ªãch)',
                        'Ly nh·ª±a (l·ªëc)',
                        'H≈© c√° ng·ª´',
                        '·ªêng h√∫t',
                        'B√¨ ƒë·ª±ng ly',
                        'H·ªôp l·ªõn',
                        'H·ªôp nh·ªè'
                        
                    ],

            "N∆∞·ªõc": [
                        'Coca chai',
                        'Coca lon',
                        'N∆∞·ªõc su·ªëi',
                        'Bia Blance',
                        'Bia Quy Nh∆°n',
                        'ƒê√° Me (b·ªãch)',
                        'M·ª©t ƒë√†o (b·ªãch)',
                        'Mi·∫øng ƒë√†o (b·ªãch)',
                        'Tr√† chanh (h·ªôp)',
                        'Tr√† ƒë√†o (h·ªôp)'
                    ],
                 "Rau c·ªß": [
                        'Salad',
                        'C√† chua',
                        'D∆∞a leo',
                        '·ªöt chu√¥ng',
                        'H√†nh t√¢y',
                        'C√† r·ªët',
                        'S√∫ t√≠m',
                    ],
        };

       

        // Sales categories and products
         const categories = [
            { id: 1, name: 'Pizza Truy·ªÅn th·ªëng' },
            { id: 2, name: 'Pizza ƒê·∫∑c bi·ªát' },
            { id: 3, name: 'M√≥n ƒÉn nh·∫π' },
            { id: 4, name: 'N∆∞·ªõc u·ªëng' },
            { id: 5, name: 'Combo' }
        ];

        const products = [
            // --- Pizza Truy·ªÅn th·ªëng ---
            { id: 1, categoryId: 1, name: 'B√≤' },
            { id: 2, categoryId: 1, name: 'Ph√¥ mai' },
            { id: 3, categoryId: 1, name: 'G√† teriyaki' },
            { id: 4, categoryId: 1, name: 'H·∫£i s·∫£n' },
            { id: 5, categoryId: 1, name: 'X√∫c x√≠ch heo' },
            { id: 6, categoryId: 1, name: 'Pizza n·∫•m rau c·ªß' },
            { id: 7, categoryId: 1, name: 'X√∫c x√≠ch ƒê·ª©c' },
            { id: 8, categoryId: 1, name: 'C√° ng·ª´' },
            { id: 9, categoryId: 1, name: 'Ba r·ªçi x√¥ng kh√≥i' },
            { id: 10, categoryId: 1, name: 'B√≤ S' },
            { id: 11, categoryId: 1, name: 'Ph√¥ mai S' },
            { id: 12, categoryId: 1, name: 'G√† teriyaki S' },
            { id: 13, categoryId: 1, name: 'X√∫c x√≠ch heo S' },
            { id: 14, categoryId: 1, name: 'C√° ng·ª´ S' },
            { id: 15, categoryId: 1, name: 'Ba r·ªçi x√¥ng kh√≥i S' },

            // --- Pizza ƒê·∫∑c bi·ªát ---
            { id: 16, categoryId: 2, name: 'Salami' },
            { id: 17, categoryId: 2, name: 'Ph√¥ mai t∆∞∆°i' },
            { id: 18, categoryId: 2, name: 'Meat Lover' },
            { id: 19, categoryId: 2, name: 'T√¥m thanh cua' },
            { id: 20, categoryId: 2, name: 'Kh√¥ g√† - L·∫°p x∆∞·ªüng' },
            { id: 21, categoryId: 2, name: 'Th·∫≠p c·∫©m' },
            { id: 22, categoryId: 2, name: 'B√≤ s·ªët cay' },
            { id: 23, categoryId: 2, name: 'H·∫£i s·∫£n ƒë·∫∑c bi·ªát' },

            
            // --- M√≥n ƒÉn nh·∫π ---
            { id: 24, categoryId: 3, name: 'G√† s·ªët cay' },
            { id: 25, categoryId: 3, name: 'Khoai t√¢y chi√™n' },
            { id: 26, categoryId: 3, name: 'Tok l·∫Øc ph√¥ mai' },
            { id: 27, categoryId: 3, name: 'B√°nh m√¨ b∆° t·ªèi' },
            { id: 28, categoryId: 3, name: 'G√† l·∫Øc ph√¥ mai cay' },
            { id: 29, categoryId: 3, name: 'G√† r√°n chi√™n gi√≤n' },
            { id: 30, categoryId: 3, name: 'M√¨ √ù ƒë√∫t l√≤' },
            { id: 31, categoryId: 3, name: 'M√¨ √ù s·ªët b√≤ b·∫±m' },
            { id: 32, categoryId: 3, name: 'Salad c√° ng·ª´' },
            { id: 33, categoryId: 3, name: 'Salad d·∫ßu gi·∫•m' },
            { id: 34, categoryId: 3, name: 'B√°nh m√¨ ph√¥ mai' },
            { id: 35, categoryId: 3, name: 'B·∫Øp ph√¥ mai' },

            // --- N∆∞·ªõc u·ªëng ---
            { id: 36, categoryId: 4, name: 'N∆∞·ªõc ng·ªçt' },
            { id: 37, categoryId: 4, name: 'N∆∞·ªõc su·ªëi' },
            { id: 38, categoryId: 4, name: 'ƒê√° me h·∫°t m·ªÅm' },
            { id: 39, categoryId: 4, name: 'Tr√† chanh' },
            { id: 40, categoryId: 4, name: 'Tr√† ƒë√†o' },
            { id: 41, categoryId: 4, name: 'Blanc 1664' },

            // --- Combo ---
            { id: 42, categoryId: 5, name: 'Combo 1' },
            { id: 43, categoryId: 5, name: 'Combo 2' },
            { id: 44, categoryId: 5, name: 'Combo 3' },
            { id: 45, categoryId: 5, name: 'Combo 4' },
            { id: 46, categoryId: 5, name: 'Combo 5' },
            { id: 47, categoryId: 5, name: 'Combo 6' },
            { id: 48, categoryId: 5, name: 'Combo 7' },
            { id: 49, categoryId: 5, name: 'Combo 8' }

        ];

        const salesCategories = categories;
        const salesProducts = products;

        let currentUser = null;
        let currentStore = null;
        let inventoryData = {};
        let adjustments = [];
        let selectedSalesCategory = null;

    

        // Initialize
        function initInventoryData() {
            inventoryData = {};
            for (let category in INVENTORY_CATEGORIES) {
                INVENTORY_CATEGORIES[category].forEach(item => {
                    inventoryData[item] = 0;
                });
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const store = document.getElementById('storeSelect').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (CREDENTIALS[store] && 
                CREDENTIALS[store].username === username && 
                CREDENTIALS[store].password === password) {
                currentStore = store;
                currentUser = username;
                showApp();
            } else {
                alert('Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!');
            }
        });

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            
            const today = new Date().toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('storeName').textContent = STORE_NAMES[currentStore];
            document.getElementById('userInfo').textContent = `${today} | Nh√¢n vi√™n: ${currentUser}`;
            
            initInventoryData();
            renderInventory();
            loadAdjustmentProducts();
            loadSalesCategories();
            
            const dateInput = document.getElementById('inventoryDate');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            
            const saleDateInput = document.getElementById('saleDate');
            if (saleDateInput) saleDateInput.value = new Date().toISOString().split('T')[0];
            
            showMainMenu();
        }

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                currentUser = null;
                currentStore = null;
            }
        }

        function showMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showSection(section) {
            // 1Ô∏è‚É£ ·∫®n menu ch√≠nh
            document.getElementById('mainMenu').style.display = 'none';

            // 2Ô∏è‚É£ ·∫®n t·∫•t c·∫£ c√°c section kh√°c
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.remove('active');
            });

            // 3Ô∏è‚É£ Hi·ªán section ƒë∆∞·ª£c ch·ªçn
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 4Ô∏è‚É£ X·ª≠ l√Ω ri√™ng cho t·ª´ng lo·∫°i section
            if (section === 'order') {
                renderOrderList();
            }

            // üßÅ N·∫øu m·ªü tab Check B√°nh ‚Üí t·ª± ƒë·ªông load d·ªØ li·ªáu t·ªìn h√¥m qua & h√¥m nay
            if (section === 'checkCake') {
                loadAllCakeData();
                const cakeDate = document.getElementById('cakeDate');
                if (cakeDate) cakeDate.value = new Date().toISOString().split('T')[0];
                const cakeUser = document.getElementById('cakeUser');
                if (cakeUser) cakeUser.value = currentUser;
            }

            // üì¶ N·∫øu m·ªü tab Ki·ªÉm h√†ng ‚Üí g√°n ng√†y & ng∆∞·ªùi ki·ªÉm
            if (section === 'inventory') {
                const invDate = document.getElementById('inventoryDate');
                if (invDate) invDate.value = new Date().toISOString().split('T')[0];
                const invUser = document.getElementById('inventoryUser');
                if (invUser) invUser.value = currentUser;
            }

            // üìä N·∫øu m·ªü tab Nh·∫≠p h√†ng b√°n ‚Üí g√°n ng√†y h√¥m nay
            if (section === 'sales') {
                const saleDate = document.getElementById('saleDate');
                if (saleDate) saleDate.value = new Date().toISOString().split('T')[0];
                 loadSalesCategories(); 
            }
            
            // üìä N·∫øu m·ªü tab Nh·∫≠p Doanh Thu ‚Üí g√°n ng√†y h√¥m nay
            if (section === 'revenue') {
                const revenueDate = document.getElementById('revenueDate');
                if (revenueDate) revenueDate.value = new Date().toISOString().split('T')[0];
            }
        }


        // Inventory functions
        function renderInventory() {
            const container = document.getElementById('inventoryList');
            container.innerHTML = '';
            
            for (let category in INVENTORY_CATEGORIES) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `${category} <span class="arrow">‚ñº</span>`;
                header.onclick = function() {
                    categoryDiv.classList.toggle('active');
                };
                
                const content = document.createElement('div');
                content.className = 'category-content';
                
                INVENTORY_CATEGORIES[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-input';
                    itemDiv.innerHTML = `
                        <label>${item}</label>
                        <input type="number" min="0" value="${inventoryData[item]}" 
                               onchange="inventoryData['${item}'] = parseInt(this.value) || 0">
                    `;
                    content.appendChild(itemDiv);
                });
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                container.appendChild(categoryDiv);
            }
        }

        function loadAdjustmentProducts() {
            const select = document.getElementById("adjustProductSelect");
            if (!select) return;

            select.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';

            for (const item of Object.keys(inventoryData)) {
                const option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            }
        }

        async function saveInventory() {
            const dateInput = document.getElementById('inventoryDate').value;
            const userInput = document.getElementById('inventoryUser').value.trim();

            if (!dateInput || !userInput) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß ng√†y v√† ng∆∞·ªùi ki·ªÉm h√†ng!");
                return;
            }

            if (!inventoryData || Object.keys(inventoryData).length === 0) {
                alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho ƒë·ªÉ l∆∞u!");
                return;
            }

            const record = {
                store_id: currentStore,
                username: currentUser,
                date: dateInput,
                inventory: inventoryData,
                input_user: userInput,
                created_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from("ton_quan")
                    .insert([record])
                    .select();

                if (error) throw error;

                alert("‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu t·ªìn kho l√™n Supabase!");
                console.log("Inserted record:", data);
            } catch (err) {
                console.error("‚ùå L·ªói khi l∆∞u l√™n Supabase:", err);
                alert("‚ùå Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu: " + err.message);
            }
        }

        function addAdjustment() {
            const productSelect = document.getElementById('adjustProductSelect');
            const qtyInput = document.getElementById('adjustQtyInput');
            const tableBody = document.getElementById('adjustmentTableBody');

            const product = productSelect.value;
            const qty = parseFloat(qtyInput.value);

            if (!product) {
                alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn s·∫£n ph·∫©m!");
                return;
            }
            if (isNaN(qty) || qty < 0) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!");
                return;
            }

            const existingIndex = adjustments.findIndex(a => a.product === product);
            if (existingIndex >= 0) {
                adjustments[existingIndex].qty = qty;
                tableBody.children[existingIndex].children[1].textContent = qty;
            } else {
                adjustments.push({ product, qty });

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product}</td>
                    <td>${qty}</td>
                    <td><button class="btn btn-remove small-btn" onclick="removeAdjustment(this, '${product}')">üóëÔ∏è</button></td>
                `;
                tableBody.appendChild(row);
            }

            productSelect.value = "";
            qtyInput.value = "";
        }

        function removeAdjustment(button, productName) {
            const row = button.closest('tr');
            adjustments = adjustments.filter(a => a.product !== productName);
            row.remove();
        }

        async function saveAdjustments() {
            if (adjustments.length === 0) {
                alert("‚ö†Ô∏è Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ ƒëi·ªÅu ch·ªânh!");
                return;
            }

            const dateInput = document.getElementById('inventoryDate').value;
            const userInput = document.getElementById('inventoryUser').value.trim();

            if (!dateInput || !userInput) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß ng√†y v√† ng∆∞·ªùi ki·ªÉm h√†ng!");
                return;
            }

            try {
                const { data: latest, error: latestError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (latestError) throw latestError;

                let inventory = latest && latest.length > 0 ? { ...latest[0].inventory } : { ...inventoryData };

                adjustments.forEach(adj => {
                    inventory[adj.product] = adj.qty;
                });

                const newRecord = {
                    store_id: currentStore,
                    date: dateInput,
                    username: currentUser,
                    input_user: userInput,
                    inventory: inventory,
                    created_at: new Date().toISOString()
                };

                const { error: insertError } = await supabase
                    .from('ton_quan')
                    .insert([newRecord])
                    .select();

                if (insertError) throw insertError;

                alert("‚úÖ ƒê√£ l∆∞u ƒëi·ªÅu ch·ªânh t·ªìn kho!");

                inventoryData = inventory;
                adjustments = [];
                document.getElementById('adjustmentTableBody').innerHTML = "";
                renderInventory();

                await new Promise(r => setTimeout(r, 500));
                await renderOrderList();

            } catch (err) {
                console.error("‚ùå L·ªói khi l∆∞u ƒëi·ªÅu ch·ªânh:", err);
                alert("‚ùå L·ªói khi l∆∞u ƒëi·ªÅu ch·ªânh: " + err.message);
            }
        }

        // ƒê·∫∑t h√†ng function
        let sortedItemNames = []; // Th√™m bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u th·ª© t·ª±

        async function renderOrderList() {
            const container = document.getElementById('orderList');
            container.innerHTML = '<div class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ªìn kho...</div>';

            try {
                const { data, error } = await supabase
                    .from('ton_quan')
                    .select('inventory, date, created_at')
                    .eq('store_id', currentStore)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="info-text">‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho cho qu√°n n√†y.</p>';
                    return;
                }

                const latest = data[0];
                inventoryData = latest.inventory || {};

                const baseLToday = inventoryData['ƒê·∫ø L'] || 0;
                const baseSToday = inventoryData['ƒê·∫ø S'] || 0;

                container.innerHTML = '';

                const sortedItems = Object.entries(inventoryData).sort((a, b) => a[1] - b[1]);
                
                // L∆∞u th·ª© t·ª± t√™n item ƒë·ªÉ d√πng khi save
                sortedItemNames = sortedItems.map(([name]) => name);

                for (const [item, stock] of sortedItems) {
                    const isLowStock = stock < 3;
                    const div = document.createElement('div');
                    div.className = `order-item${isLowStock ? ' low-stock' : ''}`;
                    div.innerHTML = `
                        <span style="font-weight: 600; color: #333;">${item}</span>
                        <span style="color: ${isLowStock ? '#dc3545' : '#28a745'}; font-weight: 600;">T·ªìn: ${stock}</span>
                        <input type="number" min="0" value="0" placeholder="S·ªë l∆∞·ª£ng ƒë·∫∑t">
                    `;
                    container.appendChild(div);
                }

                const info = document.createElement('div');
                info.className = 'info-text';
                info.textContent = `üìÖ D·ªØ li·ªáu t·ªìn kho: ${new Date(latest.date).toLocaleDateString('vi-VN')} (c·∫≠p nh·∫≠t ${new Date(latest.created_at).toLocaleString('vi-VN')})`;
                container.appendChild(info);

            } catch (err) {
                console.error('‚ùå L·ªói renderOrderList:', err);
                container.innerHTML = '<p class="alert alert-error">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ªìn kho. Vui l√≤ng th·ª≠ l·∫°i!</p>';
            }
        }

        async function saveOrder() {
            const orderItems = [];
            const inputs = document.querySelectorAll('#orderList .order-item input');
            const items = sortedItemNames;

            inputs.forEach((input, index) => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0 && items[index]) {
                    orderItems.push({
                        item: items[index],
                        current_stock: inventoryData[items[index]],
                        order_quantity: quantity
                    });
                }
            });

            if (orderItems.length === 0) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h√†ng c·∫ßn ƒë·∫∑t!');
                return;
            }

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: new Date().toISOString().split('T')[0],
                order_items: orderItems,
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('order_quan').insert([data]).select();
                if (error) throw error;

                await sendTelegramNotification(data, orderItems);

                alert('‚úÖ ƒê√£ l∆∞u ƒë∆°n h√†ng v√† g·ª≠i th√¥ng b√°o th√†nh c√¥ng!');
                document.querySelectorAll('#orderList .order-item input').forEach(input => input.value = '0');

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message);
            }
        }

        async function sendTelegramNotification(data, orderItems) {
            const botToken = '8036982528:AAEymf0l1HH47SB10gcd7QwxyugpBLxrvas';
            const chatId = '-4776196182';

            const dateStr = new Date().toLocaleString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const itemsList = orderItems
                .map(i => `${i.item.padEnd(20, ' ')} - ${i.order_quantity}`)
                .join('\n');

            const message = `üõí *ƒê∆†N ƒê·∫∂T H√ÄNG M·ªöI*

üè™ *Qu√°n:* ${STORE_NAMES[data.store_id] || 'Kh√¥ng x√°c ƒë·ªãnh'}
üë§ *Ng∆∞·ªùi ƒë·∫∑t:* ${data.username}
üìÖ *Th·ªùi gian:* ${dateStr}

üì¶ *Danh s√°ch h√†ng ƒë·∫∑t:*
\`\`\`
${itemsList}
\`\`\`

_H·ªá th·ªëng qu·∫£n l√Ω Pizza_`;

            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

            const payload = {
                chat_id: chatId,
                text: message,
                parse_mode: "Markdown"
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!result.ok) throw new Error(result.description);
            } catch (err) {
                console.warn('Telegram notification failed:', err);
            }
        }


        // Revenue functions
        function formatNumberInput(input) {
            input.addEventListener('input', () => {
                let value = input.value.replace(/[^0-9]/g, '');
                if (value) {
                    input.value = parseInt(value).toLocaleString('vi-VN');
                } else {
                    input.value = '';
                }
            });
        }

        ['cashRevenue', 'transferRevenue', 'grabRevenue', 'shopeeRevenue'].forEach(id => {
            const el = document.getElementById(id);
            if (el) formatNumberInput(el);
        });

                async function saveRevenue() {
            const revenueDate = document.getElementById('revenueDate')?.value;
            
            if (!revenueDate) {
                alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y b√°n!');
                return;
            }

            const cash = parseFloat(document.getElementById('cashRevenue').value.replace(/\./g, '')) || 0;
            const transfer = parseFloat(document.getElementById('transferRevenue').value.replace(/\./g, '')) || 0;
            const grab = parseFloat(document.getElementById('grabRevenue').value.replace(/\./g, '')) || 0;
            const shopee = parseFloat(document.getElementById('shopeeRevenue').value.replace(/\./g, '')) || 0;

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: revenueDate, // ‚Üê L∆∞u ng√†y ng∆∞·ªùi d√πng ch·ªçn
                cash_revenue: cash,
                transfer_revenue: transfer,
                grab_revenue: grab,
                shopee_revenue: shopee,
                total_revenue: cash + transfer + grab + shopee,
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('sale_quan').insert([data]).select();
                if (error) throw error;
                alert('‚úÖ ƒê√£ g·ª≠i doanh thu th√†nh c√¥ng!'); // ‚Üê ƒê·ªïi th√¥ng b√°o
                document.querySelectorAll('#revenueSection input[type="text"]').forEach(input => input.value = '');
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message);
            }
        }

        
        // Sales Tracker Functions
        function loadSalesCategories() {
            const categorySelect = document.getElementById('salesCategory');
            categorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
            salesCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        }

        function updateSalesProductList() {
            const categorySelect = document.getElementById('salesCategory');
            const categoryId = categorySelect.value;

            if (!categoryId) return;

            selectedSalesCategory = categoryId;

            const itemList = document.getElementById('salesItemList');
            itemList.innerHTML = '';

            const filteredProducts = salesProducts.filter(p => p.categoryId == categoryId);
            filteredProducts.forEach(p => addSalesItemRow(p));

            const categoryName = salesCategories.find(c => c.id == categoryId).name;
            showSalesAlert(`ƒêang nh·∫≠p cho danh m·ª•c: ${categoryName}`, "info");
        }

        function addSalesItemRow(preset = null) {
            if (!selectedSalesCategory) {
                showSalesAlert('Vui l√≤ng ch·ªçn danh m·ª•c tr∆∞·ªõc!', 'error');
                return;
            }

            const itemList = document.getElementById('salesItemList');

            const row = document.createElement('div');
            row.classList.add('item-row');

            const productSelect = document.createElement('select');
            productSelect.required = true;

            const filteredProducts = salesProducts.filter(p => p.categoryId == selectedSalesCategory);

            productSelect.innerHTML = `<option value="">-- Ch·ªçn m·∫∑t h√†ng --</option>` +
                filteredProducts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

            if (preset) productSelect.value = preset.name;

            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = 0;
            qtyInput.placeholder = 'S·ªë l∆∞·ª£ng';

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('btn', 'btn-remove');
            removeBtn.textContent = '‚úï';
            removeBtn.type = 'button';
            removeBtn.onclick = () => row.remove();

            row.appendChild(productSelect);
            row.appendChild(qtyInput);
            row.appendChild(removeBtn);

            itemList.appendChild(row);
        }

        async function saveSalesData() {
            const rows = document.querySelectorAll('#salesItemList .item-row');
            if (rows.length === 0) {
                showSalesAlert('‚ö†Ô∏è Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt m·∫∑t h√†ng!', 'error');
                return;
            }

            const saleDate = document.getElementById('saleDate').value;
            const saleEmployee = document.getElementById('saleEmployee').value.trim();

            if (!saleDate || !saleEmployee) {
                showSalesAlert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ng√†y b√°n v√† ng∆∞·ªùi nh·∫≠p!', 'error');
                return;
            }

            const salesData = [];
            let hasValidData = false;

            rows.forEach(row => {
                const productName = row.querySelector('select').value;
                const quantity = row.querySelector('input').value;

                if (productName && quantity && quantity > 0) {
                    const product = salesProducts.find(p => p.name === productName);
                    if (product) {
                        salesData.push({
                            date: saleDate,
                            store: currentStore,
                            employee: saleEmployee,
                            category: salesCategories.find(c => c.id === product.categoryId).name,
                            product_name: product.name,
                            quantity: parseInt(quantity),
                            created_at: new Date().toISOString()
                        });
                        hasValidData = true;
                    }
                }
            });

            if (!hasValidData) {
                showSalesAlert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt m·∫∑t h√†ng v·ªõi s·ªë l∆∞·ª£ng h·ª£p l·ªá!', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('pizza_sales')
                    .insert(salesData)
                    .select();

                if (error) throw error;

                showSalesAlert('‚úÖ L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                
                setTimeout(() => {
                    document.getElementById('salesItemList').innerHTML = '';
                    document.getElementById('salesCategory').value = '';
                    selectedSalesCategory = null;
                }, 1500);

            } catch (error) {
                console.error('Error:', error);
                showSalesAlert('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        function showSalesAlert(message, type) {
            const container = document.getElementById('salesAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
             

        // L·∫•y d·ªØ li·ªáu ƒë√© ng√†y h√¥m qua v√† h√¥m nay t·ª´ b·∫£ng t·ªìn qu√°n
        async function loadTonQuan() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            try {
                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa h√¥m qua
                const { data: yesterdayData, error: yError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', yesterday)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (yError) throw yError;

                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa h√¥m nay
                const { data: todayData, error: tError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (tError) throw tError;

                const yesterdayInv = yesterdayData?.[0]?.inventory || {};
                const todayInv = todayData?.[0]?.inventory || {};

                document.getElementById('baseLYesterday').value = yesterdayInv['ƒê·∫ø L'] || 0;
                document.getElementById('baseSYesterday').value = yesterdayInv['ƒê·∫ø S'] || 0;
                document.getElementById('baseLToday').value = todayInv['ƒê·∫ø L'] || 0;
                document.getElementById('baseSToday').value = todayInv['ƒê·∫ø S'] || 0;

                console.log("‚úÖ D·ªØ li·ªáu h√¥m qua (m·ªõi nh·∫•t):", yesterdayInv);
                console.log("‚úÖ D·ªØ li·ªáu h√¥m nay (m·ªõi nh·∫•t):", todayInv);

            } catch (err) {
                console.error('L·ªói khi t·∫£i t·ªìn kho:', err);
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ªìn kho. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
            }
        }
                
        
       // Helper function
        function parseIntSafe(value) {
            const num = parseInt(value);
            return isNaN(num) ? 0 : num;
        }

        // Load all data for check cake
        async function loadAllCakeData() {
            await loadTonQuan();
            await loadExportsData();
        }

        // Load t·ªìn kho t·ª´ b·∫£ng ton_quan
        async function loadTonQuan() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            try {
                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa h√¥m qua
                const { data: yesterdayData, error: yError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', yesterday)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (yError) throw yError;

                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa h√¥m nay
                const { data: todayData, error: tError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (tError) throw tError;

                const yesterdayInv = yesterdayData?.[0]?.inventory || {};
                const todayInv = todayData?.[0]?.inventory || {};

                document.getElementById('baseLYesterday').value = yesterdayInv['ƒê·∫ø L'] || 0;
                document.getElementById('baseSYesterday').value = yesterdayInv['ƒê·∫ø S'] || 0;
                document.getElementById('baseLToday').value = todayInv['ƒê·∫ø L'] || 0;
                document.getElementById('baseSToday').value = todayInv['ƒê·∫ø S'] || 0;

                console.log("‚úÖ D·ªØ li·ªáu t·ªìn kho:", { yesterdayInv, todayInv });

            } catch (err) {
                console.error('‚ùå L·ªói khi t·∫£i t·ªìn kho:', err);
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ªìn kho t·ª´ ton_quan');
            }
        }

        // Load s·ªë l∆∞·ª£ng mang ra t·ª´ b·∫£ng exports (l·∫•y b·∫£n ghi m·ªõi nh·∫•t)
        async function loadExportsData() {
            const today = new Date().toISOString().split('T')[0];

            try {
                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa ƒê·∫ø L
                const { data: dataL, error: errorL } = await supabase
                    .from('exports')
                    .select('item, quantity, created_at')
                    .eq('store', currentStore)
                    .eq('date', today)
                    .eq('item', 'ƒê·∫ø L')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (errorL) throw errorL;

                // L·∫•y b·∫£n ghi m·ªõi nh·∫•t c·ªßa ƒê·∫ø S
                const { data: dataS, error: errorS } = await supabase
                    .from('exports')
                    .select('item, quantity, created_at')
                    .eq('store', currentStore)
                    .eq('date', today)
                    .eq('item', 'ƒê·∫ø S')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (errorS) throw errorS;

                console.log("üì¶ D·ªØ li·ªáu exports m·ªõi nh·∫•t:", { dataL, dataS });

                // L·∫•y s·ªë l∆∞·ª£ng t·ª´ b·∫£n ghi m·ªõi nh·∫•t
                const qtyL = dataL?.[0] ? Math.abs(parseIntSafe(dataL[0].quantity)) : 0;
                const qtyS = dataS?.[0] ? Math.abs(parseIntSafe(dataS[0].quantity)) : 0;

                document.getElementById('baseLOut').value = qtyL;
                document.getElementById('baseSOut').value = qtyS;

                console.log("‚úÖ Mang ra (b·∫£n ghi m·ªõi nh·∫•t) - ƒê·∫ø L:", qtyL, "| ƒê·∫ø S:", qtyS);

            } catch (err) {
                console.error('‚ùå L·ªói khi t·∫£i exports:', err);
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu mang ra t·ª´ b·∫£ng exports');
            }
        }

        // Ki·ªÉm tra b√°nh
        async function checkCake() {
            const today = new Date().toISOString().split('T')[0];
            
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const LYesterday = parseIntSafe(document.getElementById('baseLYesterday').value);
            const SYesterday = parseIntSafe(document.getElementById('baseSYesterday').value);
            const LToday = parseIntSafe(document.getElementById('baseLToday').value);
            const SToday = parseIntSafe(document.getElementById('baseSToday').value);
            const LOut = parseIntSafe(document.getElementById('baseLOut').value);
            const SOut = parseIntSafe(document.getElementById('baseSOut').value);
            const LDiscard = parseIntSafe(document.getElementById('baseLDiscard').value);
            const SDiscard = parseIntSafe(document.getElementById('baseSDiscard').value);
            const LMachine = parseIntSafe(document.getElementById('baseLMachine').value);
            const SMachine = parseIntSafe(document.getElementById('baseSMachine').value);

            console.log('üìä D·ªØ li·ªáu check b√°nh:', {
                LYesterday, SYesterday, LToday, SToday,
                LOut, SOut, LDiscard, SDiscard, LMachine, SMachine
            });

            // T√≠nh to√°n
            const LActual = LYesterday - LToday + LOut - LDiscard;
            const SActual = SYesterday - SToday + SOut - SDiscard;
            const LDiff = LActual - LMachine;
            const SDiff = SActual - SMachine;

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            function makeLine(label, actual, machine, diff) {
                if (diff === 0) {
                    return `<p style="font-size: 18px; margin: 10px 0;">üëâ ${label} th·ª±c t·∫ø: <b>${actual}</b> | M√°y b√°o: <b>${machine}</b> ‚Üí <span style="color:green; font-weight: bold;">‚úÖ ƒê·ªß</span></p>`;
                } else if (diff > 0) {
                    return `<p style="font-size: 18px; margin: 10px 0;">üëâ ${label} th·ª±c t·∫ø: <b>${actual}</b> | M√°y b√°o: <b>${machine}</b> ‚Üí <span style="color:crimson; font-weight: bold;">‚ö†Ô∏è Thi·∫øu ${diff}</span></p>`;
                } else {
                    return `<p style="font-size: 18px; margin: 10px 0;">üëâ ${label} th·ª±c t·∫ø: <b>${actual}</b> | M√°y b√°o: <b>${machine}</b> ‚Üí <span style="color:blue; font-weight: bold;">‚úÖ D∆∞ ${-diff}</span></p>`;
                }
            }

            const resultText = `
                <h3 style="margin-bottom: 15px; color: #667eea;">üìã K·∫øt qu·∫£ ki·ªÉm tra</h3>
                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">üìÖ H√¥m qua: ƒê·∫ø L=${LYesterday}, ƒê·∫ø S=${SYesterday} | H√¥m nay: ƒê·∫ø L=${LToday}, ƒê·∫ø S=${SToday}</p>
                ${makeLine('ƒê·∫ø L', LActual, LMachine, LDiff)}
                ${makeLine('ƒê·∫ø S', SActual, SMachine, SDiff)}
            `;
            
            const resultDiv = document.getElementById('cakeResult');
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = 'block';

            // L∆∞u k·∫øt qu·∫£ ƒë·ªÉ g·ª≠i Discord
            lastCakeCheckResult = {
                date: today,
                store: currentStore,
                user: document.getElementById('cakeUser')?.value || 'Kh√¥ng r√µ',
                LYesterday, SYesterday, LToday, SToday,
                LOut, SOut, LDiscard, SDiscard, LMachine, SMachine,
                LActual, SActual, LDiff, SDiff
            };

            // Hi·ªÉn th·ªã n√∫t g·ª≠i Discord
            document.getElementById('sendDiscordBtn').style.display = 'block';

            console.log('‚úÖ K·∫øt qu·∫£ ki·ªÉm tra:', lastCakeCheckResult);
        }

        // H√†m g·ª≠i k·∫øt qu·∫£ qua Discord
        async function sendCakeResultToDiscord() {
            if (!lastCakeCheckResult) {
                alert('‚ö†Ô∏è Vui l√≤ng ki·ªÉm tra b√°nh tr∆∞·ªõc khi g·ª≠i!');
                return;
            }

            const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1429805698413232238/GAygBOBeaQQfL_G9m4_KA-UZVJ3d62WFPTDpJaX-8PwxRe3shjrnwmCXRggKRkqUEz1S'; // Thay b·∫±ng webhook URL c·ªßa b·∫°n

            const r = lastCakeCheckResult;
            
            const embedColor = (r.LDiff === 0 && r.SDiff === 0) ? 3066993 : // Green
                            (r.LDiff > 0 || r.SDiff > 0) ? 15158332 : // Red
                            3447003; // Blue

            const discordPayload = {
                embeds: [{
                    title: 'üßÅ K·∫øt Qu·∫£ Ki·ªÉm Tra B√°nh',
                    color: embedColor,
                    fields: [
                        { name: 'üìÖ Ng√†y', value: r.date, inline: true },
                        { name: 'üè™ Qu√°n', value: r.store, inline: true },
                        { name: 'üë§ Ng∆∞·ªùi ki·ªÉm', value: r.user, inline: true },
                        { name: '\u200B', value: '\u200B' },
                        { name: 'üìä S·ªë li·ªáu h√¥m qua', value: `ƒê·∫ø L: ${r.LYesterday} | ƒê·∫ø S: ${r.SYesterday}`, inline: false },
                        { name: 'üìä S·ªë li·ªáu h√¥m nay', value: `ƒê·∫ø L: ${r.LToday} | ƒê·∫ø S: ${r.SToday}`, inline: false },
                        { name: 'üì¶ Mang ra', value: `ƒê·∫ø L: ${r.LOut} | ƒê·∫ø S: ${r.SOut}`, inline: false },
                        { name: 'üóëÔ∏è B·ªè ƒëi', value: `ƒê·∫ø L: ${r.LDiscard} | ƒê·∫ø S: ${r.SDiscard}`, inline: false },
                        { name: 'ü§ñ M√°y b√°n', value: `ƒê·∫ø L: ${r.LMachine} | ƒê·∫ø S: ${r.SMachine}`, inline: false },
                        { name: '\u200B', value: '\u200B' },
                        { 
                            name: 'üîç K·∫øt qu·∫£ ƒê·∫ø L', 
                            value: `Th·ª±c t·∫ø: **${r.LActual}** | M√°y: **${r.LMachine}** ‚Üí ${
                                r.LDiff === 0 ? '‚úÖ **ƒê·ªß**' : 
                                r.LDiff > 0 ? `‚ö†Ô∏è **Thi·∫øu ${r.LDiff}**` : 
                                `‚úÖ **D∆∞ ${-r.LDiff}**`
                            }`, 
                            inline: false 
                        },
                        { 
                            name: 'üîç K·∫øt qu·∫£ ƒê·∫ø S', 
                            value: `Th·ª±c t·∫ø: **${r.SActual}** | M√°y: **${r.SMachine}** ‚Üí ${
                                r.SDiff === 0 ? '‚úÖ **ƒê·ªß**' : 
                                r.SDiff > 0 ? `‚ö†Ô∏è **Thi·∫øu ${r.SDiff}**` : 
                                `‚úÖ **D∆∞ ${-r.SDiff}**`
                            }`, 
                            inline: false 
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: 'H·ªá th·ªëng qu·∫£n l√Ω b√°nh' }
                }]
            };

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(discordPayload)
                });

                if (response.ok) {
                    alert('‚úÖ ƒê√£ g·ª≠i k·∫øt qu·∫£ th√†nh c√¥ng!');
                    document.getElementById('sendDiscordBtn').style.display = 'none';
                    lastCakeCheckResult = null; // Reset sau khi g·ª≠i
                } else {
                    throw new Error('Discord webhook failed');
                }
            } catch (err) {
                console.error('‚ùå L·ªói g·ª≠i Discord:', err);
                alert('‚ùå Kh√¥ng th·ªÉ g·ª≠i qua Discord. Vui l√≤ng ki·ªÉm tra webhook URL!');
            }
        }
    </script>
</body>
</html>
