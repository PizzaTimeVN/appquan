<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Pizza</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff; /* Màu trắng */
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h3 {
            color: #333;
            font-size: 24px;
        }

        .header p {
            color: #666;
            margin-top: 5px;
        }

        .btn-logout {
            padding: 10px 25px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tab-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tab-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .tab-card p {
            color: #777;
            font-size: 14px;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .back-btn {
            background: #6c757d;
            width: auto;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .category-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .category-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header:hover {
            background: #e9ecef;
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-item.active .category-content {
            max-height: 2000px;
            padding: 20px;
        }

        .item-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .item-input:last-child {
            border-bottom: none;
        }

        .item-input label {
            flex: 1;
            color: #555;
        }

        .item-input input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .save-btn {
            margin-top: 30px;
            background: #28a745;
        }

        .save-btn:hover {
            background: #218838;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group-inline {
            display: flex;
            flex-direction: column;
        }

        .input-group-inline label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group-inline input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .adjustment-box {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .adjustment-box h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .adjustment-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
        }

        .adjustment-row select,
        .adjustment-row input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .small-btn {
            padding: 10px 20px;
            width: auto;
        }

        .adjustment-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .adjustment-table th,
        .adjustment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .adjustment-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .order-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .order-item.low-stock {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .order-item input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .revenue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .revenue-item label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        .revenue-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .item-list {
            margin: 20px 0;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .item-row select,
        .item-row input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .btn-add {
            background: #17a2b8;
            width: auto;
            padding: 12px 30px;
            margin-right: 10px;
        }

        .btn-remove {
            background: #dc3545;
            width: auto;
            padding: 10px 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .info-text {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            color: #004085;
        }

        @media (max-width: 768px) {
            .tabs {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .item-row {
                grid-template-columns: 1fr;
            }

            .adjustment-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-box">
                <h2>🍕 Quản Lý Pizza</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Chọn Quán</label>
                        <select id="storeSelect" required>
                            <option value="">-- Chọn quán --</option>
                            <option value="DH">DH</option>
                            <option value="NH">NH</option>
                            <option value="HXH">HXH</option>
                            <option value="PY">PY</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tên Đăng Nhập</label>
                        <input type="text" id="username" required placeholder="Nhập tên đăng nhập">
                    </div>
                    <div class="form-group">
                        <label>Mật Khẩu</label>
                        <input type="password" id="password" required placeholder="Nhập mật khẩu">
                    </div>
                    <button type="submit" class="btn">Đăng Nhập</button>
                </form>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="appScreen" class="hidden">
            <div class="header">
                <div class="header-info">
                    <h3 id="storeName"></h3>
                    <p id="userInfo"></p>
                </div>
                <button class="btn-logout" onclick="logout()">Đăng Xuất</button>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu">
                <div class="tabs">
                    <div class="tab-card" onclick="showSection('revenue')">
                        <h3>💰 Nhập Doanh Thu</h3>
                        <p>Tiền mặt, chuyển khoản, Grab, Shopee</p>
                    </div>
                    <div class="tab-card" onclick="showSection('inventory')">
                        <h3>📦 Kiểm Hàng</h3>
                        <p>Kiểm tra tồn kho theo danh mục</p>
                    </div>
                    <div class="tab-card" onclick="showSection('order')">
                        <h3>🛒 Đặt Hàng</h3>
                        <p>Đặt hàng giao từ xưởng</p>
                    </div>
                    <div class="tab-card" onclick="showSection('sales')">
                        <h3>📊 Nhập Hàng Bán</h3>
                        <p>Theo dõi doanh số bán hàng</p>
                    </div>
                    <div class="tab-card" onclick="showSection('checkCake')">
                        <h3>🧁 Check Bánh</h3>
                        <p>Kiểm tra số lượng bánh bán thực tế</p>
                    </div>
                </div>
            </div>

            <!-- Revenue Section -->
            <div id="revenueSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="revenueDate">📅 Ngày nhập:</label>
                        <input type="date" id="revenueDate">
                    </div>
                </div>
                <h2 class="section-title">Nhập Doanh Thu</h2>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>💵 Tiền Mặt (VNĐ)</label>
                        <input type="text" id="cashRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>🏦 Chuyển Khoản (VNĐ)</label>
                        <input type="text" id="transferRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>🚗 Grab (VNĐ)</label>
                        <input type="text" id="grabRevenue" placeholder="0">
                    </div>
                    <div class="revenue-item">
                        <label>🛍️ Shopee (VNĐ)</label>
                        <input type="text" id="shopeeRevenue" placeholder="0">
                    </div>
                </div>
                <button class="btn save-btn" onclick="saveRevenue()">Lưu Doanh Thu</button>
            </div>

            <!-- Inventory Section -->
            <div id="inventorySection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
                
                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="inventoryDate">📅 Ngày nhập:</label>
                        <input type="date" id="inventoryDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="inventoryUser">👤 Người nhập:</label>
                        <input type="text" id="inventoryUser" placeholder="Nhập tên người kiểm hàng">
                    </div>
                </div>

                <h2 class="section-title">Kiểm Hàng Tồn Kho</h2>
                <div id="inventoryList" class="category-list"></div>
                <button class="btn save-btn" onclick="saveInventory()">💾 Lưu Kiểm Hàng</button>

                <div class="adjustment-box">
                    <h3>🔧 Điều chỉnh hàng tồn</h3>
                    <div class="adjustment-row">
                        <select id="adjustProductSelect">
                            <option value="">-- Chọn sản phẩm --</option>
                        </select>
                        <input type="number" id="adjustQtyInput" placeholder="Số lượng mới" min="0">
                        <button class="btn small-btn" onclick="addAdjustment()">+ Thêm</button>
                    </div>
                    <table class="adjustment-table">
                        <thead>
                            <tr>
                                <th>Tên hàng</th>
                                <th>Số lượng mới</th>
                                <th>Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="adjustmentTableBody"></tbody>
                    </table>
                    <button class="btn save-btn" onclick="saveAdjustments()">💾 Lưu thay đổi</button>
                </div>
            </div>

            <!-- Order Section -->
            <div id="orderSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
                <h2 class="section-title">Đặt Hàng Từ Xưởng</h2>
                <div id="orderList"></div>
                <button class="btn save-btn" onclick="saveOrder()">Gửi Đơn Đặt Hàng</button>
            </div>

            <!-- Sales Section -->
            <div id="salesSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
                <h2 class="section-title">Nhập Hàng Bán</h2>
                
                <div id="salesAlertContainer"></div>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="saleDate">📅 Ngày bán:</label>
                        <input type="date" id="saleDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="saleEmployee">👤 Người nhập:</label>
                        <input type="text" id="saleEmployee" placeholder="Nhập tên người nhập">
                    </div>
                </div>

                <div class="form-group">
                    <label for="salesCategory">Danh mục</label>
                    <select id="salesCategory" onchange="updateSalesProductList()">
                        <option value="">-- Chọn danh mục --</option>
                    </select>
                </div>

                <div class="item-list" id="salesItemList"></div>

                <button class="btn btn-add" onclick="addSalesItemRow()">+ Thêm mặt hàng</button>
                <button class="btn save-btn" onclick="saveSalesData()">Lưu dữ liệu bán hàng</button>
            </div>

       <!-- Check Cake Section -->
            <div id="checkCakeSection" class="content-section">
                <button class="btn back-btn" onclick="showMainMenu()">← Quay Lại</button>
                <h2 class="section-title">🧁 Check Bánh</h2>

                <div class="input-row">
                    <div class="input-group-inline">
                        <label for="cakeDate">📅 Ngày kiểm:</label>
                        <input type="date" id="cakeDate">
                    </div>
                    <div class="input-group-inline">
                        <label for="cakeUser">👤 Người kiểm:</label>
                        <input type="text" id="cakeUser" placeholder="Nhập tên người kiểm bánh">
                    </div>
                </div>

                <h3 style="margin-top: 20px; margin-bottom: 15px;">Số lượng đế hôm qua & hôm nay (tự động)</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>Đế L hôm qua</label>
                        <input type="number" id="baseLYesterday" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>Đế S hôm qua</label>
                        <input type="number" id="baseSYesterday" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>Đế L hôm nay</label>
                        <input type="number" id="baseLToday" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>Đế S hôm nay</label>
                        <input type="number" id="baseSToday" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Số lượng mang ra (tự động)</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>Đế L mang ra</label>
                        <input type="number" id="baseLOut" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                    <div class="revenue-item">
                        <label>Đế S mang ra</label>
                        <input type="number" id="baseSOut" placeholder="Tự động lấy" min="0" readonly>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Nhập số lượng đế bỏ & máy bán</h3>
                <div class="revenue-grid">
                    <div class="revenue-item">
                        <label>Đế L bỏ</label>
                        <input type="number" id="baseLDiscard" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>Đế S bỏ</label>
                        <input type="number" id="baseSDiscard" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>Đế L máy bán</label>
                        <input type="number" id="baseLMachine" placeholder="0" min="0" value="0">
                    </div>
                    <div class="revenue-item">
                        <label>Đế S máy bán</label>
                        <input type="number" id="baseSMachine" placeholder="0" min="0" value="0">
                    </div>
                </div>

                <button class="btn save-btn" onclick="checkCake()">🔍 Kiểm Tra Kết Quả</button>

                <div id="cakeResult" class="result-box" style="margin-top: 20px; display: none;"></div>

                <!-- Nút gửi Discord - hiện sau khi kiểm tra -->
                <button class="btn save-btn" onclick="sendCakeResultToDiscord()" id="sendDiscordBtn" style="display:none; margin-top: 15px; background-color: #5865F2;">
                    📤 Gửi Kết Quả 
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tyuufjwutazjfuiawiul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5dXVmand1dGF6amZ1aWF3aXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDk4OTIsImV4cCI6MjA3NjA4NTg5Mn0.8WEsb2tBD6akNA9h9tR9zIAqjkZz0xZYVNbYCx2dEbc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Login credentials
        const CREDENTIALS = {
            'DH': { username: 'DH258', password: '258DH' },
            'NH': { username: 'NH141', password: '141NH' },
            'HXH': { username: 'HXH01', password: '01HXH' },
            'PY': { username: 'BT227', password: '227BT' }
        };

        const STORE_NAMES = {
            'DH': 'DH',
            'NH': 'NH',
            'HXH': 'HXH',
            'PY': 'PY'
        };

        // Inventory categories
        const INVENTORY_CATEGORIES = {
           'Làm bánh': [
                        'Đế L',
                        'Đế S',
                        'Phô Mai L',
                        'Phô Mai S',
                        'Bò pizza (bịch)',
                        'Bò mì Ý (bịch)',
                        'Gà pizza (bịch)',
                        'Tôm (bịch)',
                        'Mực (bịch)',
                        'Cá Ngừ (bịch)',
                        'XXH (bịch)',
                        'XXĐ (bịch)',
                        'Ba Rọi (bịch)',
                        'Bò sốt cay (bịch)',
                        'Sốt sữa (bịch)',
                        'Sốt cà (hũ)',
                        'Sốt Gà',
                        'Salami (bịch)',
                        'Nấm (bịch)',
                        'Bông Cải Xanh (bịch)',
                        
                    ],

            'Món ăn nhẹ': [
                'Gà Lắc (bịch)',
                'Đùi Gà (cái)',
                        'XX Chiên Xù',
                        'Bom Phô Mai (viên)',
                        'KTC (bịch)',
                        'Mì ý chưa luộc',
                        'Bánh mì',
                        'Tok (bịch)'

            ],    

             'Bao bì ': [
                        'Bao 1 món (kg)',
                        'Bao pizza lớn (kg)',
                        'Bao cân mì (kg)',
                        'Bao rác (kg)',
                        'Dây thun (bịch)',
                        'Ly nhựa (lốc)',
                        'Hũ cá ngừ',
                        'Ống hút',
                        'Bì đựng ly',
                        'Hộp lớn',
                        'Hộp nhỏ'
                        
                    ],

            "Nước": [
                        'Coca chai',
                        'Coca lon',
                        'Nước suối',
                        'Bia Blance',
                        'Bia Quy Nhơn',
                        'Đá Me (bịch)',
                        'Mứt đào (bịch)',
                        'Miếng đào (bịch)',
                        'Trà chanh (hộp)',
                        'Trà đào (hộp)'
                    ],
                 "Rau củ": [
                        'Salad',
                        'Cà chua',
                        'Dưa leo',
                        'Ớt chuông',
                        'Hành tây',
                        'Cà rốt',
                        'Sú tím',
                    ],
        };

       

        // Sales categories and products
         const categories = [
            { id: 1, name: 'Pizza Truyền thống' },
            { id: 2, name: 'Pizza Đặc biệt' },
            { id: 3, name: 'Món ăn nhẹ' },
            { id: 4, name: 'Nước uống' },
            { id: 5, name: 'Combo' }
        ];

        const products = [
            // --- Pizza Truyền thống ---
            { id: 1, categoryId: 1, name: 'Bò' },
            { id: 2, categoryId: 1, name: 'Phô mai' },
            { id: 3, categoryId: 1, name: 'Gà teriyaki' },
            { id: 4, categoryId: 1, name: 'Hải sản' },
            { id: 5, categoryId: 1, name: 'Xúc xích heo' },
            { id: 6, categoryId: 1, name: 'Pizza nấm rau củ' },
            { id: 7, categoryId: 1, name: 'Xúc xích Đức' },
            { id: 8, categoryId: 1, name: 'Cá ngừ' },
            { id: 9, categoryId: 1, name: 'Ba rọi xông khói' },
            { id: 10, categoryId: 1, name: 'Bò S' },
            { id: 11, categoryId: 1, name: 'Phô mai S' },
            { id: 12, categoryId: 1, name: 'Gà teriyaki S' },
            { id: 13, categoryId: 1, name: 'Xúc xích heo S' },
            { id: 14, categoryId: 1, name: 'Cá ngừ S' },
            { id: 15, categoryId: 1, name: 'Ba rọi xông khói S' },

            // --- Pizza Đặc biệt ---
            { id: 16, categoryId: 2, name: 'Salami' },
            { id: 17, categoryId: 2, name: 'Phô mai tươi' },
            { id: 18, categoryId: 2, name: 'Meat Lover' },
            { id: 19, categoryId: 2, name: 'Tôm thanh cua' },
            { id: 20, categoryId: 2, name: 'Khô gà - Lạp xưởng' },
            { id: 21, categoryId: 2, name: 'Thập cẩm' },
            { id: 22, categoryId: 2, name: 'Bò sốt cay' },
            { id: 23, categoryId: 2, name: 'Hải sản đặc biệt' },

            
            // --- Món ăn nhẹ ---
            { id: 24, categoryId: 3, name: 'Gà sốt cay' },
            { id: 25, categoryId: 3, name: 'Khoai tây chiên' },
            { id: 26, categoryId: 3, name: 'Tok lắc phô mai' },
            { id: 27, categoryId: 3, name: 'Bánh mì bơ tỏi' },
            { id: 28, categoryId: 3, name: 'Gà lắc phô mai cay' },
            { id: 29, categoryId: 3, name: 'Gà rán chiên giòn' },
            { id: 30, categoryId: 3, name: 'Mì Ý đút lò' },
            { id: 31, categoryId: 3, name: 'Mì Ý sốt bò bằm' },
            { id: 32, categoryId: 3, name: 'Salad cá ngừ' },
            { id: 33, categoryId: 3, name: 'Salad dầu giấm' },
            { id: 34, categoryId: 3, name: 'Bánh mì phô mai' },
            { id: 35, categoryId: 3, name: 'Bắp phô mai' },

            // --- Nước uống ---
            { id: 36, categoryId: 4, name: 'Nước ngọt' },
            { id: 37, categoryId: 4, name: 'Nước suối' },
            { id: 38, categoryId: 4, name: 'Đá me hạt mềm' },
            { id: 39, categoryId: 4, name: 'Trà chanh' },
            { id: 40, categoryId: 4, name: 'Trà đào' },
            { id: 41, categoryId: 4, name: 'Blanc 1664' },

            // --- Combo ---
            { id: 42, categoryId: 5, name: 'Combo 1' },
            { id: 43, categoryId: 5, name: 'Combo 2' },
            { id: 44, categoryId: 5, name: 'Combo 3' },
            { id: 45, categoryId: 5, name: 'Combo 4' },
            { id: 46, categoryId: 5, name: 'Combo 5' },
            { id: 47, categoryId: 5, name: 'Combo 6' },
            { id: 48, categoryId: 5, name: 'Combo 7' },
            { id: 49, categoryId: 5, name: 'Combo 8' }

        ];

        const salesCategories = categories;
        const salesProducts = products;

        let currentUser = null;
        let currentStore = null;
        let inventoryData = {};
        let adjustments = [];
        let selectedSalesCategory = null;

    

        // Initialize
        function initInventoryData() {
            inventoryData = {};
            for (let category in INVENTORY_CATEGORIES) {
                INVENTORY_CATEGORIES[category].forEach(item => {
                    inventoryData[item] = 0;
                });
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const store = document.getElementById('storeSelect').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (CREDENTIALS[store] && 
                CREDENTIALS[store].username === username && 
                CREDENTIALS[store].password === password) {
                currentStore = store;
                currentUser = username;
                showApp();
            } else {
                alert('Sai tên đăng nhập hoặc mật khẩu!');
            }
        });

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            
            const today = new Date().toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('storeName').textContent = STORE_NAMES[currentStore];
            document.getElementById('userInfo').textContent = `${today} | Nhân viên: ${currentUser}`;
            
            initInventoryData();
            renderInventory();
            loadAdjustmentProducts();
            loadSalesCategories();
            
            const dateInput = document.getElementById('inventoryDate');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            
            const saleDateInput = document.getElementById('saleDate');
            if (saleDateInput) saleDateInput.value = new Date().toISOString().split('T')[0];
            
            showMainMenu();
        }

        function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                currentUser = null;
                currentStore = null;
            }
        }

        function showMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
        }

        function showSection(section) {
            // 1️⃣ Ẩn menu chính
            document.getElementById('mainMenu').style.display = 'none';

            // 2️⃣ Ẩn tất cả các section khác
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.remove('active');
            });

            // 3️⃣ Hiện section được chọn
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 4️⃣ Xử lý riêng cho từng loại section
            if (section === 'order') {
                renderOrderList();
            }

            // 🧁 Nếu mở tab Check Bánh → tự động load dữ liệu tồn hôm qua & hôm nay
            if (section === 'checkCake') {
                loadAllCakeData();
                const cakeDate = document.getElementById('cakeDate');
                if (cakeDate) cakeDate.value = new Date().toISOString().split('T')[0];
                const cakeUser = document.getElementById('cakeUser');
                if (cakeUser) cakeUser.value = currentUser;
            }

            // 📦 Nếu mở tab Kiểm hàng → gán ngày & người kiểm
            if (section === 'inventory') {
                const invDate = document.getElementById('inventoryDate');
                if (invDate) invDate.value = new Date().toISOString().split('T')[0];
                const invUser = document.getElementById('inventoryUser');
                if (invUser) invUser.value = currentUser;
            }

            // 📊 Nếu mở tab Nhập hàng bán → gán ngày hôm nay
            if (section === 'sales') {
                const saleDate = document.getElementById('saleDate');
                if (saleDate) saleDate.value = new Date().toISOString().split('T')[0];
                 loadSalesCategories(); 
            }
            
            // 📊 Nếu mở tab Nhập Doanh Thu → gán ngày hôm nay
            if (section === 'revenue') {
                const revenueDate = document.getElementById('revenueDate');
                if (revenueDate) revenueDate.value = new Date().toISOString().split('T')[0];
            }
        }


        // Inventory functions
        function renderInventory() {
            const container = document.getElementById('inventoryList');
            container.innerHTML = '';
            
            for (let category in INVENTORY_CATEGORIES) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `${category} <span class="arrow">▼</span>`;
                header.onclick = function() {
                    categoryDiv.classList.toggle('active');
                };
                
                const content = document.createElement('div');
                content.className = 'category-content';
                
                INVENTORY_CATEGORIES[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-input';
                    itemDiv.innerHTML = `
                        <label>${item}</label>
                        <input type="number" min="0" value="${inventoryData[item]}" 
                               onchange="inventoryData['${item}'] = parseInt(this.value) || 0">
                    `;
                    content.appendChild(itemDiv);
                });
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                container.appendChild(categoryDiv);
            }
        }

        function loadAdjustmentProducts() {
            const select = document.getElementById("adjustProductSelect");
            if (!select) return;

            select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';

            for (const item of Object.keys(inventoryData)) {
                const option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            }
        }

        async function saveInventory() {
            const dateInput = document.getElementById('inventoryDate').value;
            const userInput = document.getElementById('inventoryUser').value.trim();

            if (!dateInput || !userInput) {
                alert("⚠️ Vui lòng nhập đủ ngày và người kiểm hàng!");
                return;
            }

            if (!inventoryData || Object.keys(inventoryData).length === 0) {
                alert("⚠️ Không có dữ liệu tồn kho để lưu!");
                return;
            }

            const record = {
                store_id: currentStore,
                username: currentUser,
                date: dateInput,
                inventory: inventoryData,
                input_user: userInput,
                created_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from("ton_quan")
                    .insert([record])
                    .select();

                if (error) throw error;

                alert("✅ Đã lưu dữ liệu tồn kho lên Supabase!");
                console.log("Inserted record:", data);
            } catch (err) {
                console.error("❌ Lỗi khi lưu lên Supabase:", err);
                alert("❌ Không thể lưu dữ liệu: " + err.message);
            }
        }

        function addAdjustment() {
            const productSelect = document.getElementById('adjustProductSelect');
            const qtyInput = document.getElementById('adjustQtyInput');
            const tableBody = document.getElementById('adjustmentTableBody');

            const product = productSelect.value;
            const qty = parseFloat(qtyInput.value);

            if (!product) {
                alert("⚠️ Vui lòng chọn sản phẩm!");
                return;
            }
            if (isNaN(qty) || qty < 0) {
                alert("⚠️ Vui lòng nhập số lượng hợp lệ!");
                return;
            }

            const existingIndex = adjustments.findIndex(a => a.product === product);
            if (existingIndex >= 0) {
                adjustments[existingIndex].qty = qty;
                tableBody.children[existingIndex].children[1].textContent = qty;
            } else {
                adjustments.push({ product, qty });

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product}</td>
                    <td>${qty}</td>
                    <td><button class="btn btn-remove small-btn" onclick="removeAdjustment(this, '${product}')">🗑️</button></td>
                `;
                tableBody.appendChild(row);
            }

            productSelect.value = "";
            qtyInput.value = "";
        }

        function removeAdjustment(button, productName) {
            const row = button.closest('tr');
            adjustments = adjustments.filter(a => a.product !== productName);
            row.remove();
        }

        async function saveAdjustments() {
            if (adjustments.length === 0) {
                alert("⚠️ Chưa có sản phẩm nào để điều chỉnh!");
                return;
            }

            const dateInput = document.getElementById('inventoryDate').value;
            const userInput = document.getElementById('inventoryUser').value.trim();

            if (!dateInput || !userInput) {
                alert("⚠️ Vui lòng nhập đủ ngày và người kiểm hàng!");
                return;
            }

            try {
                const { data: latest, error: latestError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (latestError) throw latestError;

                let inventory = latest && latest.length > 0 ? { ...latest[0].inventory } : { ...inventoryData };

                adjustments.forEach(adj => {
                    inventory[adj.product] = adj.qty;
                });

                const newRecord = {
                    store_id: currentStore,
                    date: dateInput,
                    username: currentUser,
                    input_user: userInput,
                    inventory: inventory,
                    created_at: new Date().toISOString()
                };

                const { error: insertError } = await supabase
                    .from('ton_quan')
                    .insert([newRecord])
                    .select();

                if (insertError) throw insertError;

                alert("✅ Đã lưu điều chỉnh tồn kho!");

                inventoryData = inventory;
                adjustments = [];
                document.getElementById('adjustmentTableBody').innerHTML = "";
                renderInventory();

                await new Promise(r => setTimeout(r, 500));
                await renderOrderList();

            } catch (err) {
                console.error("❌ Lỗi khi lưu điều chỉnh:", err);
                alert("❌ Lỗi khi lưu điều chỉnh: " + err.message);
            }
        }

        // Đặt hàng function
        let sortedItemNames = []; // Thêm biến toàn cục để lưu thứ tự

        async function renderOrderList() {
            const container = document.getElementById('orderList');
            container.innerHTML = '<div class="loading">⏳ Đang tải dữ liệu tồn kho...</div>';

            try {
                const { data, error } = await supabase
                    .from('ton_quan')
                    .select('inventory, date, created_at')
                    .eq('store_id', currentStore)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="info-text">⚠️ Chưa có dữ liệu tồn kho cho quán này.</p>';
                    return;
                }

                const latest = data[0];
                inventoryData = latest.inventory || {};

                const baseLToday = inventoryData['Đế L'] || 0;
                const baseSToday = inventoryData['Đế S'] || 0;

                container.innerHTML = '';

                const sortedItems = Object.entries(inventoryData).sort((a, b) => a[1] - b[1]);
                
                // Lưu thứ tự tên item để dùng khi save
                sortedItemNames = sortedItems.map(([name]) => name);

                for (const [item, stock] of sortedItems) {
                    const isLowStock = stock < 3;
                    const div = document.createElement('div');
                    div.className = `order-item${isLowStock ? ' low-stock' : ''}`;
                    div.innerHTML = `
                        <span style="font-weight: 600; color: #333;">${item}</span>
                        <span style="color: ${isLowStock ? '#dc3545' : '#28a745'}; font-weight: 600;">Tồn: ${stock}</span>
                        <input type="number" min="0" value="0" placeholder="Số lượng đặt">
                    `;
                    container.appendChild(div);
                }

                const info = document.createElement('div');
                info.className = 'info-text';
                info.textContent = `📅 Dữ liệu tồn kho: ${new Date(latest.date).toLocaleDateString('vi-VN')} (cập nhật ${new Date(latest.created_at).toLocaleString('vi-VN')})`;
                container.appendChild(info);

            } catch (err) {
                console.error('❌ Lỗi renderOrderList:', err);
                container.innerHTML = '<p class="alert alert-error">❌ Không thể tải dữ liệu tồn kho. Vui lòng thử lại!</p>';
            }
        }

        async function saveOrder() {
            const orderItems = [];
            const inputs = document.querySelectorAll('#orderList .order-item input');
            const items = sortedItemNames;

            inputs.forEach((input, index) => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0 && items[index]) {
                    orderItems.push({
                        item: items[index],
                        current_stock: inventoryData[items[index]],
                        order_quantity: quantity
                    });
                }
            });

            if (orderItems.length === 0) {
                alert('⚠️ Vui lòng nhập số lượng hàng cần đặt!');
                return;
            }

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: new Date().toISOString().split('T')[0],
                order_items: orderItems,
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('order_quan').insert([data]).select();
                if (error) throw error;

                await sendTelegramNotification(data, orderItems);

                alert('✅ Đã lưu đơn hàng và gửi thông báo thành công!');
                document.querySelectorAll('#orderList .order-item input').forEach(input => input.value = '0');

            } catch (error) {
                console.error('Error:', error);
                alert('❌ Có lỗi khi lưu dữ liệu: ' + error.message);
            }
        }

        async function sendTelegramNotification(data, orderItems) {
            const botToken = '8036982528:AAEymf0l1HH47SB10gcd7QwxyugpBLxrvas';
            const chatId = '-4776196182';

            const dateStr = new Date().toLocaleString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const itemsList = orderItems
                .map(i => `${i.item.padEnd(20, ' ')} - ${i.order_quantity}`)
                .join('\n');

            const message = `🛒 *ĐƠN ĐẶT HÀNG MỚI*

🏪 *Quán:* ${STORE_NAMES[data.store_id] || 'Không xác định'}
👤 *Người đặt:* ${data.username}
📅 *Thời gian:* ${dateStr}

📦 *Danh sách hàng đặt:*
\`\`\`
${itemsList}
\`\`\`

_Hệ thống quản lý Pizza_`;

            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

            const payload = {
                chat_id: chatId,
                text: message,
                parse_mode: "Markdown"
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!result.ok) throw new Error(result.description);
            } catch (err) {
                console.warn('Telegram notification failed:', err);
            }
        }


        // Revenue functions
        function formatNumberInput(input) {
            input.addEventListener('input', () => {
                let value = input.value.replace(/[^0-9]/g, '');
                if (value) {
                    input.value = parseInt(value).toLocaleString('vi-VN');
                } else {
                    input.value = '';
                }
            });
        }

        ['cashRevenue', 'transferRevenue', 'grabRevenue', 'shopeeRevenue'].forEach(id => {
            const el = document.getElementById(id);
            if (el) formatNumberInput(el);
        });

                async function saveRevenue() {
            const revenueDate = document.getElementById('revenueDate')?.value;
            
            if (!revenueDate) {
                alert('⚠️ Vui lòng chọn ngày bán!');
                return;
            }

            const cash = parseFloat(document.getElementById('cashRevenue').value.replace(/\./g, '')) || 0;
            const transfer = parseFloat(document.getElementById('transferRevenue').value.replace(/\./g, '')) || 0;
            const grab = parseFloat(document.getElementById('grabRevenue').value.replace(/\./g, '')) || 0;
            const shopee = parseFloat(document.getElementById('shopeeRevenue').value.replace(/\./g, '')) || 0;

            const data = {
                store_id: currentStore,
                username: currentUser,
                date: revenueDate, // ← Lưu ngày người dùng chọn
                cash_revenue: cash,
                transfer_revenue: transfer,
                grab_revenue: grab,
                shopee_revenue: shopee,
                total_revenue: cash + transfer + grab + shopee,
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('sale_quan').insert([data]).select();
                if (error) throw error;
                alert('✅ Đã gửi doanh thu thành công!'); // ← Đổi thông báo
                document.querySelectorAll('#revenueSection input[type="text"]').forEach(input => input.value = '');
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Có lỗi khi lưu dữ liệu: ' + error.message);
            }
        }

        
        // Sales Tracker Functions
        function loadSalesCategories() {
            const categorySelect = document.getElementById('salesCategory');
            categorySelect.innerHTML = '<option value="">-- Chọn danh mục --</option>';
            salesCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        }

        function updateSalesProductList() {
            const categorySelect = document.getElementById('salesCategory');
            const categoryId = categorySelect.value;

            if (!categoryId) return;

            selectedSalesCategory = categoryId;

            const itemList = document.getElementById('salesItemList');
            itemList.innerHTML = '';

            const filteredProducts = salesProducts.filter(p => p.categoryId == categoryId);
            filteredProducts.forEach(p => addSalesItemRow(p));

            const categoryName = salesCategories.find(c => c.id == categoryId).name;
            showSalesAlert(`Đang nhập cho danh mục: ${categoryName}`, "info");
        }

        function addSalesItemRow(preset = null) {
            if (!selectedSalesCategory) {
                showSalesAlert('Vui lòng chọn danh mục trước!', 'error');
                return;
            }

            const itemList = document.getElementById('salesItemList');

            const row = document.createElement('div');
            row.classList.add('item-row');

            const productSelect = document.createElement('select');
            productSelect.required = true;

            const filteredProducts = salesProducts.filter(p => p.categoryId == selectedSalesCategory);

            productSelect.innerHTML = `<option value="">-- Chọn mặt hàng --</option>` +
                filteredProducts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

            if (preset) productSelect.value = preset.name;

            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = 0;
            qtyInput.placeholder = 'Số lượng';

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('btn', 'btn-remove');
            removeBtn.textContent = '✕';
            removeBtn.type = 'button';
            removeBtn.onclick = () => row.remove();

            row.appendChild(productSelect);
            row.appendChild(qtyInput);
            row.appendChild(removeBtn);

            itemList.appendChild(row);
        }

        async function saveSalesData() {
            const rows = document.querySelectorAll('#salesItemList .item-row');
            if (rows.length === 0) {
                showSalesAlert('⚠️ Vui lòng thêm ít nhất một mặt hàng!', 'error');
                return;
            }

            const saleDate = document.getElementById('saleDate').value;
            const saleEmployee = document.getElementById('saleEmployee').value.trim();

            if (!saleDate || !saleEmployee) {
                showSalesAlert('⚠️ Vui lòng điền đầy đủ ngày bán và người nhập!', 'error');
                return;
            }

            const salesData = [];
            let hasValidData = false;

            rows.forEach(row => {
                const productName = row.querySelector('select').value;
                const quantity = row.querySelector('input').value;

                if (productName && quantity && quantity > 0) {
                    const product = salesProducts.find(p => p.name === productName);
                    if (product) {
                        salesData.push({
                            date: saleDate,
                            store: currentStore,
                            employee: saleEmployee,
                            category: salesCategories.find(c => c.id === product.categoryId).name,
                            product_name: product.name,
                            quantity: parseInt(quantity),
                            created_at: new Date().toISOString()
                        });
                        hasValidData = true;
                    }
                }
            });

            if (!hasValidData) {
                showSalesAlert('⚠️ Vui lòng nhập ít nhất một mặt hàng với số lượng hợp lệ!', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('pizza_sales')
                    .insert(salesData)
                    .select();

                if (error) throw error;

                showSalesAlert('✅ Lưu dữ liệu thành công!', 'success');
                
                setTimeout(() => {
                    document.getElementById('salesItemList').innerHTML = '';
                    document.getElementById('salesCategory').value = '';
                    selectedSalesCategory = null;
                }, 1500);

            } catch (error) {
                console.error('Error:', error);
                showSalesAlert('❌ Lỗi khi lưu dữ liệu: ' + error.message, 'error');
            }
        }

        function showSalesAlert(message, type) {
            const container = document.getElementById('salesAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
             

        // Lấy dữ liệu đé ngày hôm qua và hôm nay từ bảng tồn quán
        async function loadTonQuan() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            try {
                // Lấy bản ghi mới nhất của hôm qua
                const { data: yesterdayData, error: yError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', yesterday)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (yError) throw yError;

                // Lấy bản ghi mới nhất của hôm nay
                const { data: todayData, error: tError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (tError) throw tError;

                const yesterdayInv = yesterdayData?.[0]?.inventory || {};
                const todayInv = todayData?.[0]?.inventory || {};

                document.getElementById('baseLYesterday').value = yesterdayInv['Đế L'] || 0;
                document.getElementById('baseSYesterday').value = yesterdayInv['Đế S'] || 0;
                document.getElementById('baseLToday').value = todayInv['Đế L'] || 0;
                document.getElementById('baseSToday').value = todayInv['Đế S'] || 0;

                console.log("✅ Dữ liệu hôm qua (mới nhất):", yesterdayInv);
                console.log("✅ Dữ liệu hôm nay (mới nhất):", todayInv);

            } catch (err) {
                console.error('Lỗi khi tải tồn kho:', err);
                alert('⚠️ Không thể tải dữ liệu tồn kho. Vui lòng kiểm tra kết nối.');
            }
        }
                
        
       // Helper function
        function parseIntSafe(value) {
            const num = parseInt(value);
            return isNaN(num) ? 0 : num;
        }

        // Load all data for check cake
        async function loadAllCakeData() {
            await loadTonQuan();
            await loadExportsData();
        }

        // Load tồn kho từ bảng ton_quan
        async function loadTonQuan() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            try {
                // Lấy bản ghi mới nhất của hôm qua
                const { data: yesterdayData, error: yError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', yesterday)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (yError) throw yError;

                // Lấy bản ghi mới nhất của hôm nay
                const { data: todayData, error: tError } = await supabase
                    .from('ton_quan')
                    .select('inventory')
                    .eq('store_id', currentStore)
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (tError) throw tError;

                const yesterdayInv = yesterdayData?.[0]?.inventory || {};
                const todayInv = todayData?.[0]?.inventory || {};

                document.getElementById('baseLYesterday').value = yesterdayInv['Đế L'] || 0;
                document.getElementById('baseSYesterday').value = yesterdayInv['Đế S'] || 0;
                document.getElementById('baseLToday').value = todayInv['Đế L'] || 0;
                document.getElementById('baseSToday').value = todayInv['Đế S'] || 0;

                console.log("✅ Dữ liệu tồn kho:", { yesterdayInv, todayInv });

            } catch (err) {
                console.error('❌ Lỗi khi tải tồn kho:', err);
                alert('⚠️ Không thể tải dữ liệu tồn kho từ ton_quan');
            }
        }

        // Load số lượng mang ra từ bảng exports (lấy bản ghi mới nhất)
        async function loadExportsData() {
            const today = new Date().toISOString().split('T')[0];

            try {
                // Lấy bản ghi mới nhất của Đế L
                const { data: dataL, error: errorL } = await supabase
                    .from('exports')
                    .select('item, quantity, created_at')
                    .eq('store', currentStore)
                    .eq('date', today)
                    .eq('item', 'Đế L')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (errorL) throw errorL;

                // Lấy bản ghi mới nhất của Đế S
                const { data: dataS, error: errorS } = await supabase
                    .from('exports')
                    .select('item, quantity, created_at')
                    .eq('store', currentStore)
                    .eq('date', today)
                    .eq('item', 'Đế S')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (errorS) throw errorS;

                console.log("📦 Dữ liệu exports mới nhất:", { dataL, dataS });

                // Lấy số lượng từ bản ghi mới nhất
                const qtyL = dataL?.[0] ? Math.abs(parseIntSafe(dataL[0].quantity)) : 0;
                const qtyS = dataS?.[0] ? Math.abs(parseIntSafe(dataS[0].quantity)) : 0;

                document.getElementById('baseLOut').value = qtyL;
                document.getElementById('baseSOut').value = qtyS;

                console.log("✅ Mang ra (bản ghi mới nhất) - Đế L:", qtyL, "| Đế S:", qtyS);

            } catch (err) {
                console.error('❌ Lỗi khi tải exports:', err);
                alert('⚠️ Không thể tải dữ liệu mang ra từ bảng exports');
            }
        }

        // Kiểm tra bánh
        async function checkCake() {
            const today = new Date().toISOString().split('T')[0];
            
            // Lấy dữ liệu từ form
            const LYesterday = parseIntSafe(document.getElementById('baseLYesterday').value);
            const SYesterday = parseIntSafe(document.getElementById('baseSYesterday').value);
            const LToday = parseIntSafe(document.getElementById('baseLToday').value);
            const SToday = parseIntSafe(document.getElementById('baseSToday').value);
            const LOut = parseIntSafe(document.getElementById('baseLOut').value);
            const SOut = parseIntSafe(document.getElementById('baseSOut').value);
            const LDiscard = parseIntSafe(document.getElementById('baseLDiscard').value);
            const SDiscard = parseIntSafe(document.getElementById('baseSDiscard').value);
            const LMachine = parseIntSafe(document.getElementById('baseLMachine').value);
            const SMachine = parseIntSafe(document.getElementById('baseSMachine').value);

            console.log('📊 Dữ liệu check bánh:', {
                LYesterday, SYesterday, LToday, SToday,
                LOut, SOut, LDiscard, SDiscard, LMachine, SMachine
            });

            // Tính toán
            const LActual = LYesterday - LToday + LOut - LDiscard;
            const SActual = SYesterday - SToday + SOut - SDiscard;
            const LDiff = LActual - LMachine;
            const SDiff = SActual - SMachine;

            // Hiển thị kết quả
            function makeLine(label, actual, machine, diff) {
                if (diff === 0) {
                    return `<p style="font-size: 18px; margin: 10px 0;">👉 ${label} thực tế: <b>${actual}</b> | Máy báo: <b>${machine}</b> → <span style="color:green; font-weight: bold;">✅ Đủ</span></p>`;
                } else if (diff > 0) {
                    return `<p style="font-size: 18px; margin: 10px 0;">👉 ${label} thực tế: <b>${actual}</b> | Máy báo: <b>${machine}</b> → <span style="color:crimson; font-weight: bold;">⚠️ Thiếu ${diff}</span></p>`;
                } else {
                    return `<p style="font-size: 18px; margin: 10px 0;">👉 ${label} thực tế: <b>${actual}</b> | Máy báo: <b>${machine}</b> → <span style="color:blue; font-weight: bold;">✅ Dư ${-diff}</span></p>`;
                }
            }

            const resultText = `
                <h3 style="margin-bottom: 15px; color: #667eea;">📋 Kết quả kiểm tra</h3>
                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">📅 Hôm qua: Đế L=${LYesterday}, Đế S=${SYesterday} | Hôm nay: Đế L=${LToday}, Đế S=${SToday}</p>
                ${makeLine('Đế L', LActual, LMachine, LDiff)}
                ${makeLine('Đế S', SActual, SMachine, SDiff)}
            `;
            
            const resultDiv = document.getElementById('cakeResult');
            resultDiv.innerHTML = resultText;
            resultDiv.style.display = 'block';

            // Lưu kết quả để gửi Discord
            lastCakeCheckResult = {
                date: today,
                store: currentStore,
                user: document.getElementById('cakeUser')?.value || 'Không rõ',
                LYesterday, SYesterday, LToday, SToday,
                LOut, SOut, LDiscard, SDiscard, LMachine, SMachine,
                LActual, SActual, LDiff, SDiff
            };

            // Hiển thị nút gửi Discord
            document.getElementById('sendDiscordBtn').style.display = 'block';

            console.log('✅ Kết quả kiểm tra:', lastCakeCheckResult);
        }

        // Hàm gửi kết quả qua Discord
        async function sendCakeResultToDiscord() {
            if (!lastCakeCheckResult) {
                alert('⚠️ Vui lòng kiểm tra bánh trước khi gửi!');
                return;
            }

            const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1429805698413232238/GAygBOBeaQQfL_G9m4_KA-UZVJ3d62WFPTDpJaX-8PwxRe3shjrnwmCXRggKRkqUEz1S'; // Thay bằng webhook URL của bạn

            const r = lastCakeCheckResult;
            
            const embedColor = (r.LDiff === 0 && r.SDiff === 0) ? 3066993 : // Green
                            (r.LDiff > 0 || r.SDiff > 0) ? 15158332 : // Red
                            3447003; // Blue

            const discordPayload = {
                embeds: [{
                    title: '🧁 Kết Quả Kiểm Tra Bánh',
                    color: embedColor,
                    fields: [
                        { name: '📅 Ngày', value: r.date, inline: true },
                        { name: '🏪 Quán', value: r.store, inline: true },
                        { name: '👤 Người kiểm', value: r.user, inline: true },
                        { name: '\u200B', value: '\u200B' },
                        { name: '📊 Số liệu hôm qua', value: `Đế L: ${r.LYesterday} | Đế S: ${r.SYesterday}`, inline: false },
                        { name: '📊 Số liệu hôm nay', value: `Đế L: ${r.LToday} | Đế S: ${r.SToday}`, inline: false },
                        { name: '📦 Mang ra', value: `Đế L: ${r.LOut} | Đế S: ${r.SOut}`, inline: false },
                        { name: '🗑️ Bỏ đi', value: `Đế L: ${r.LDiscard} | Đế S: ${r.SDiscard}`, inline: false },
                        { name: '🤖 Máy bán', value: `Đế L: ${r.LMachine} | Đế S: ${r.SMachine}`, inline: false },
                        { name: '\u200B', value: '\u200B' },
                        { 
                            name: '🔍 Kết quả Đế L', 
                            value: `Thực tế: **${r.LActual}** | Máy: **${r.LMachine}** → ${
                                r.LDiff === 0 ? '✅ **Đủ**' : 
                                r.LDiff > 0 ? `⚠️ **Thiếu ${r.LDiff}**` : 
                                `✅ **Dư ${-r.LDiff}**`
                            }`, 
                            inline: false 
                        },
                        { 
                            name: '🔍 Kết quả Đế S', 
                            value: `Thực tế: **${r.SActual}** | Máy: **${r.SMachine}** → ${
                                r.SDiff === 0 ? '✅ **Đủ**' : 
                                r.SDiff > 0 ? `⚠️ **Thiếu ${r.SDiff}**` : 
                                `✅ **Dư ${-r.SDiff}**`
                            }`, 
                            inline: false 
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: 'Hệ thống quản lý bánh' }
                }]
            };

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(discordPayload)
                });

                if (response.ok) {
                    alert('✅ Đã gửi kết quả thành công!');
                    document.getElementById('sendDiscordBtn').style.display = 'none';
                    lastCakeCheckResult = null; // Reset sau khi gửi
                } else {
                    throw new Error('Discord webhook failed');
                }
            } catch (err) {
                console.error('❌ Lỗi gửi Discord:', err);
                alert('❌ Không thể gửi qua Discord. Vui lòng kiểm tra webhook URL!');
            }
        }
    </script>
</body>
</html>
